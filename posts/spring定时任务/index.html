<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Spring Task定时任务 | 猫公会</title><meta name=keywords content><meta name=description content="初认识 基本使用 1、添加基本依赖 2、 @EnableScheduling 注解开启定时任务 @Scheduled 注释标注定时任务方法 通过注册ScheduledAnnotationBeanPostProcessor来执行@Scheduled注释的处理。这可以手动完成，或者更方便地通过task:ann"><meta name=author content="
作者:&nbsp;Me"><link rel=canonical href=https://www.catguild.cn/posts/spring%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.9c7c35e2f76542323b21747a40f1590c09c8cb45d08e4d7c82e632663381bae6.css integrity="sha256-nHw14vdlQjI7IXR6QPFZDAnIy0XQjk18guYyZjOBuuY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.catguild.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://www.catguild.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://www.catguild.cn/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://www.catguild.cn/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://www.catguild.cn/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-49K5GYEZX0"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-49K5GYEZX0")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?6e15f273a2871fda1150e7f434efa838",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="Spring Task定时任务"><meta property="og:description" content="初认识 基本使用 1、添加基本依赖 2、 @EnableScheduling 注解开启定时任务 @Scheduled 注释标注定时任务方法 通过注册ScheduledAnnotationBeanPostProcessor来执行@Scheduled注释的处理。这可以手动完成，或者更方便地通过task:ann"><meta property="og:type" content="article"><meta property="og:url" content="https://www.catguild.cn/posts/spring%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"><meta property="og:image" content="https://www.catguild.cn/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="og:site_name" content="ExampleSite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.catguild.cn/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="Spring Task定时任务"><meta name=twitter:description content="初认识 基本使用 1、添加基本依赖 2、 @EnableScheduling 注解开启定时任务 @Scheduled 注释标注定时任务方法 通过注册ScheduledAnnotationBeanPostProcessor来执行@Scheduled注释的处理。这可以手动完成，或者更方便地通过task:ann"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.catguild.cn/posts/"},{"@type":"ListItem","position":2,"name":"Spring Task定时任务","item":"https://www.catguild.cn/posts/spring%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Spring Task定时任务","name":"Spring Task定时任务","description":"初认识 基本使用 1、添加基本依赖 2、 @EnableScheduling 注解开启定时任务 @Scheduled 注释标注定时任务方法 通过注册ScheduledAnnotationBeanPostProcessor来执行@Scheduled注释的处理。这可以手动完成，或者更方便地通过task:ann","keywords":[],"articleBody":"初认识 基本使用 1、添加基本依赖 2、 @EnableScheduling 注解开启定时任务\n@Scheduled 注释标注定时任务方法\n通过注册ScheduledAnnotationBeanPostProcessor来执行@Scheduled注释的处理。这可以手动完成，或者更方便地通过task:annotation-driven/XML元素或@EnableScheduling annotation来完成。\n三种触发器 实际运行一下 import lombok.extern.slf4j.Slf4j; import org.springframework.scheduling.annotation.EnableScheduling; import org.springframework.scheduling.annotation.Scheduled; import org.springframework.stereotype.Component; /** * @author xiyan * @date 2023/7/5 14:36 */ @Slf4j @EnableScheduling @Component public class DemoScheduledTest { /** * 固定延迟时间 * 间隔 5s ，执行 3s、实际间隔8s * 2023-07-06 17:36:05.068 * 2023-07-06 17:36:13.091 * 2023-07-06 17:36:21.109 * 2023-07-06 17:36:29.134 * 2023-07-06 17:36:37.149 * * 间隔 5s ，执行 5s、实际间隔10s * 2023-07-05 14:38:46.182 * 2023-07-05 14:38:56.196 * 2023-07-05 14:39:06.210 * 2023-07-05 14:39:16.235 * 2023-07-05 14:39:26.244 * * 间隔 5s ，执行 7s、实际间隔12s * 2023-07-05 14:45:02.764 * 2023-07-05 14:45:14.775 * 2023-07-05 14:45:26.796 * 2023-07-05 14:45:38.814 * 2023-07-05 14:45:50.830 * * 下次执行时间=上次执行时间+(fixedDelay时间+执行耗时) */ @Scheduled(fixedDelay = 5000) public void test1() { try { log.info(\"test1方法执行=====\u003e\u003e\u003e\u003e\"); Thread.sleep(3000); } catch (InterruptedException e) { throw new RuntimeException(e); } } /** * 固定间隔时间 * 间隔5s、执行3s、实际间隔5s * 2023-07-06 18:00:11.362 * 2023-07-06 18:00:16.352 * 2023-07-06 18:00:21.358 * 2023-07-06 18:00:26.355 * 2023-07-06 18:00:31.364 * * 间隔 5s ，执行 5s、实际间隔5s * 2023-07-05 14:40:39.180 * 2023-07-05 14:40:44.185 * 2023-07-05 14:40:49.200 * 2023-07-05 14:40:54.212 * 2023-07-05 14:40:59.226 * * 间隔5s，执行7s、实际间隔7s * 2023-07-05 14:41:45.559 * 2023-07-05 14:41:52.567 * 2023-07-05 14:41:59.581 * 2023-07-05 14:42:06.588 * 2023-07-05 14:42:13.593 * * 下次执行时间=上次执行时间+ max(fixedRate, 执行耗时) */ @Scheduled(fixedRate = 5000) public void test2() { try { log.info(\"test2方法执行=====\u003e\u003e\u003e\u003e\"); Thread.sleep(3000); } catch (InterruptedException e) { throw new RuntimeException(e); } } /** * cron表达式 * * 间隔5s、执行3s、实际间隔5s * 2023-07-06 17:55:10.015 * 2023-07-06 17:55:15.001 * 2023-07-06 17:55:20.014 * 2023-07-06 17:55:25.007 * 2023-07-06 17:55:30.008 * * 间隔 5s ，执行 5s、实际间隔10s * 2023-07-06 17:49:55.008 * 2023-07-06 17:50:05.014 * 2023-07-06 17:50:15.000 * 2023-07-06 17:50:25.004 * 2023-07-06 17:50:35.005 * * 间隔5s，执行7s、实际间隔10s * 2023-07-06 17:51:55.016 * 2023-07-06 17:52:05.008 * 2023-07-06 17:52:15.001 * 2023-07-06 17:52:25.010 * 2023-07-06 17:52:35.014 * * 下次执行时间=如果到达定时时间，上一个任务已完成，将会执行，否则会跳过 */ @Scheduled(cron = \"0/5 * * * * ?\") public void test3() { try { log.info(\"test3方法执行=====\u003e\u003e\u003e\u003e\"); Thread.sleep(5000); } catch (InterruptedException e) { throw new RuntimeException(e); } } } 为什么会这样 运行原理 /** Bean后处理器，注册用@Scheduled注释的方法，以便由TaskScheduler根据通过注释提供的“fixedRate”、“fixedDelay”或“cron”表达式调用。 这个后处理器由Spring的XML元素以及@EnableScheduling注释自动注册。 自动检测容器中的任何SchedulingConfigurer实例，允许自定义要使用的计划程序或对任务注册进行细粒度控制（例如，注册触发器任务）。 */ org.springframework.scheduling.annotation.ScheduledAnnotationBeanPostProcessor 关键类\n/** * Bean post-processor that registers methods annotated with * {@link Scheduled @Scheduled} to be invoked by a * {@link org.springframework.scheduling.TaskScheduler} according to the * \"fixedRate\", \"fixedDelay\", or \"cron\" expression provided via the annotation. * * This post-processor is automatically registered by Spring's * {@code } XML element, and also by the * {@link EnableScheduling @EnableScheduling} annotation. * * Autodetects any {@link SchedulingConfigurer} instances in the container, * allowing for customization of the scheduler to be used or for fine-grained * control over task registration (e.g. registration of {@link Trigger} tasks). * See the {@link EnableScheduling @EnableScheduling} javadocs for complete usage * details. * * @author Mark Fisher * @author Juergen Hoeller * @author Chris Beams * @author Elizabeth Chatman * @author Victor Brown * @author Sam Brannen * @since 3.0 * @see Scheduled * @see EnableScheduling * @see SchedulingConfigurer * @see org.springframework.scheduling.TaskScheduler * @see org.springframework.scheduling.config.ScheduledTaskRegistrar * @see AsyncAnnotationBeanPostProcessor */ public class ScheduledAnnotationBeanPostProcessor implements ScheduledTaskHolder, MergedBeanDefinitionPostProcessor, DestructionAwareBeanPostProcessor, Ordered, EmbeddedValueResolverAware, BeanNameAware, BeanFactoryAware, ApplicationContextAware, SmartInitializingSingleton, ApplicationListener\u003cContextRefreshedEvent\u003e, DisposableBean { /** * The default name of the {@link TaskScheduler} bean to pick up: {@value}. * Note that the initial lookup happens by type; this is just the fallback * in case of multiple scheduler beans found in the context. * @since 4.2 */ public static final String DEFAULT_TASK_SCHEDULER_BEAN_NAME = \"taskScheduler\"; protected final Log logger = LogFactory.getLog(getClass()); private final ScheduledTaskRegistrar registrar; @Nullable private Object scheduler; @Nullable private StringValueResolver embeddedValueResolver; @Nullable private String beanName; @Nullable private BeanFactory beanFactory; @Nullable private ApplicationContext applicationContext; private final Set\u003cClass\u003c?\u003e\u003e nonAnnotatedClasses = Collections.newSetFromMap(new ConcurrentHashMap\u003c\u003e(64)); private final Map\u003cObject, Set\u003cScheduledTask\u003e\u003e scheduledTasks = new IdentityHashMap\u003c\u003e(16); /** * Create a default {@code ScheduledAnnotationBeanPostProcessor}. */ public ScheduledAnnotationBeanPostProcessor() { this.registrar = new ScheduledTaskRegistrar(); } /** * Create a {@code ScheduledAnnotationBeanPostProcessor} delegating to the * specified {@link ScheduledTaskRegistrar}. * @param registrar the ScheduledTaskRegistrar to register {@code @Scheduled} * tasks on * @since 5.1 */ public ScheduledAnnotationBeanPostProcessor(ScheduledTaskRegistrar registrar) { Assert.notNull(registrar, \"ScheduledTaskRegistrar is required\"); this.registrar = registrar; } @Override public int getOrder() { return LOWEST_PRECEDENCE; } /** * Set the {@link org.springframework.scheduling.TaskScheduler} that will invoke * the scheduled methods, or a {@link java.util.concurrent.ScheduledExecutorService} * to be wrapped as a TaskScheduler. * If not specified, default scheduler resolution will apply: searching for a * unique {@link TaskScheduler} bean in the context, or for a {@link TaskScheduler} * bean named \"taskScheduler\" otherwise; the same lookup will also be performed for * a {@link ScheduledExecutorService} bean. If neither of the two is resolvable, * a local single-threaded default scheduler will be created within the registrar. * @see #DEFAULT_TASK_SCHEDULER_BEAN_NAME */ public void setScheduler(Object scheduler) { this.scheduler = scheduler; } @Override public void setEmbeddedValueResolver(StringValueResolver resolver) { this.embeddedValueResolver = resolver; } @Override public void setBeanName(String beanName) { this.beanName = beanName; } /** * Making a {@link BeanFactory} available is optional; if not set, * {@link SchedulingConfigurer} beans won't get autodetected and * a {@link #setScheduler scheduler} has to be explicitly configured. */ @Override public void setBeanFactory(BeanFactory beanFactory) { this.beanFactory = beanFactory; } /** * Setting an {@link ApplicationContext} is optional: If set, registered * tasks will be activated in the {@link ContextRefreshedEvent} phase; * if not set, it will happen at {@link #afterSingletonsInstantiated} time. */ @Override public void setApplicationContext(ApplicationContext applicationContext) { this.applicationContext = applicationContext; if (this.beanFactory == null) { this.beanFactory = applicationContext; } } @Override public void afterSingletonsInstantiated() { // Remove resolved singleton classes from cache this.nonAnnotatedClasses.clear(); if (this.applicationContext == null) { // Not running in an ApplicationContext -\u003e register tasks early... finishRegistration(); } } @Override public void onApplicationEvent(ContextRefreshedEvent event) { if (event.getApplicationContext() == this.applicationContext) { // Running in an ApplicationContext -\u003e register tasks this late... // giving other ContextRefreshedEvent listeners a chance to perform // their work at the same time (e.g. Spring Batch's job registration). finishRegistration(); } } /** * 关键的注册逻辑 */ private void finishRegistration() { if (this.scheduler != null) { this.registrar.setScheduler(this.scheduler); } // 解析实现了 SchedulingConfigurer 接口的注册类，编程式任务注册 if (this.beanFactory instanceof ListableBeanFactory) { Map\u003cString, SchedulingConfigurer\u003e beans = ((ListableBeanFactory) this.beanFactory).getBeansOfType(SchedulingConfigurer.class); List\u003cSchedulingConfigurer\u003e configurers = new ArrayList\u003c\u003e(beans.values()); AnnotationAwareOrderComparator.sort(configurers); for (SchedulingConfigurer configurer : configurers) { configurer.configureTasks(this.registrar); } } // 如果注册器中有任务，则注册任务 if (this.registrar.hasTasks() \u0026\u0026 this.registrar.getScheduler() == null) { Assert.state(this.beanFactory != null, \"BeanFactory must be set to find scheduler by type\"); try { // Search for TaskScheduler bean... this.registrar.setTaskScheduler(resolveSchedulerBean(this.beanFactory, TaskScheduler.class, false)); } catch (NoUniqueBeanDefinitionException ex) { if (logger.isTraceEnabled()) { logger.trace(\"Could not find unique TaskScheduler bean - attempting to resolve by name: \" + ex.getMessage()); } try { this.registrar.setTaskScheduler(resolveSchedulerBean(this.beanFactory, TaskScheduler.class, true)); } catch (NoSuchBeanDefinitionException ex2) { if (logger.isInfoEnabled()) { logger.info(\"More than one TaskScheduler bean exists within the context, and \" + \"none is named 'taskScheduler'. Mark one of them as primary or name it 'taskScheduler' \" + \"(possibly as an alias); or implement the SchedulingConfigurer interface and call \" + \"ScheduledTaskRegistrar#setScheduler explicitly within the configureTasks() callback: \" + ex.getBeanNamesFound()); } } } catch (NoSuchBeanDefinitionException ex) { if (logger.isTraceEnabled()) { logger.trace(\"Could not find default TaskScheduler bean - attempting to find ScheduledExecutorService: \" + ex.getMessage()); } // Search for ScheduledExecutorService bean next... try { this.registrar.setScheduler(resolveSchedulerBean(this.beanFactory, ScheduledExecutorService.class, false)); } catch (NoUniqueBeanDefinitionException ex2) { if (logger.isTraceEnabled()) { logger.trace(\"Could not find unique ScheduledExecutorService bean - attempting to resolve by name: \" + ex2.getMessage()); } try { this.registrar.setScheduler(resolveSchedulerBean(this.beanFactory, ScheduledExecutorService.class, true)); } catch (NoSuchBeanDefinitionException ex3) { if (logger.isInfoEnabled()) { logger.info(\"More than one ScheduledExecutorService bean exists within the context, and \" + \"none is named 'taskScheduler'. Mark one of them as primary or name it 'taskScheduler' \" + \"(possibly as an alias); or implement the SchedulingConfigurer interface and call \" + \"ScheduledTaskRegistrar#setScheduler explicitly within the configureTasks() callback: \" + ex2.getBeanNamesFound()); } } } catch (NoSuchBeanDefinitionException ex2) { if (logger.isTraceEnabled()) { logger.trace(\"Could not find default ScheduledExecutorService bean - falling back to default: \" + ex2.getMessage()); } // Giving up -\u003e falling back to default scheduler within the registrar... logger.info(\"No TaskScheduler/ScheduledExecutorService bean found for scheduled processing\"); } } } this.registrar.afterPropertiesSet(); } private \u003cT\u003e T resolveSchedulerBean(BeanFactory beanFactory, Class\u003cT\u003e schedulerType, boolean byName) { if (byName) { T scheduler = beanFactory.getBean(DEFAULT_TASK_SCHEDULER_BEAN_NAME, schedulerType); if (this.beanName != null \u0026\u0026 this.beanFactory instanceof ConfigurableBeanFactory) { ((ConfigurableBeanFactory) this.beanFactory).registerDependentBean( DEFAULT_TASK_SCHEDULER_BEAN_NAME, this.beanName); } return scheduler; } else if (beanFactory instanceof AutowireCapableBeanFactory) { NamedBeanHolder\u003cT\u003e holder = ((AutowireCapableBeanFactory) beanFactory).resolveNamedBean(schedulerType); if (this.beanName != null \u0026\u0026 beanFactory instanceof ConfigurableBeanFactory) { ((ConfigurableBeanFactory) beanFactory).registerDependentBean(holder.getBeanName(), this.beanName); } return holder.getBeanInstance(); } else { return beanFactory.getBean(schedulerType); } } @Override public void postProcessMergedBeanDefinition(RootBeanDefinition beanDefinition, Class\u003c?\u003e beanType, String beanName) { } @Override public Object postProcessBeforeInitialization(Object bean, String beanName) { return bean; } @Override public Object postProcessAfterInitialization(Object bean, String beanName) { if (bean instanceof AopInfrastructureBean || bean instanceof TaskScheduler || bean instanceof ScheduledExecutorService) { // Ignore AOP infrastructure such as scoped proxies. return bean; } Class\u003c?\u003e targetClass = AopProxyUtils.ultimateTargetClass(bean); if (!this.nonAnnotatedClasses.contains(targetClass) \u0026\u0026 AnnotationUtils.isCandidateClass(targetClass, Arrays.asList(Scheduled.class, Schedules.class))) { Map\u003cMethod, Set\u003cScheduled\u003e\u003e annotatedMethods = MethodIntrospector.selectMethods(targetClass, (MethodIntrospector.MetadataLookup\u003cSet\u003cScheduled\u003e\u003e) method -\u003e { Set\u003cScheduled\u003e scheduledAnnotations = AnnotatedElementUtils.getMergedRepeatableAnnotations( method, Scheduled.class, Schedules.class); return (!scheduledAnnotations.isEmpty() ? scheduledAnnotations : null); }); if (annotatedMethods.isEmpty()) { this.nonAnnotatedClasses.add(targetClass); if (logger.isTraceEnabled()) { logger.trace(\"No @Scheduled annotations found on bean class: \" + targetClass); } } else { // Non-empty set of methods annotatedMethods.forEach((method, scheduledAnnotations) -\u003e scheduledAnnotations.forEach(scheduled -\u003e processScheduled(scheduled, method, bean))); if (logger.isTraceEnabled()) { logger.trace(annotatedMethods.size() + \" @Scheduled methods processed on bean '\" + beanName + \"': \" + annotatedMethods); } } } return bean; } /** * Process the given {@code @Scheduled} method declaration on the given bean. * @param scheduled the {@code @Scheduled} annotation * @param method the method that the annotation has been declared on * @param bean the target bean instance * @see #createRunnable(Object, Method) */ protected void processScheduled(Scheduled scheduled, Method method, Object bean) { try { Runnable runnable = createRunnable(bean, method); boolean processedSchedule = false; String errorMessage = \"Exactly one of the 'cron', 'fixedDelay(String)', or 'fixedRate(String)' attributes is required\"; Set\u003cScheduledTask\u003e tasks = new LinkedHashSet\u003c\u003e(4); // Determine initial delay long initialDelay = convertToMillis(scheduled.initialDelay(), scheduled.timeUnit()); String initialDelayString = scheduled.initialDelayString(); if (StringUtils.hasText(initialDelayString)) { Assert.isTrue(initialDelay \u003c 0, \"Specify 'initialDelay' or 'initialDelayString', not both\"); if (this.embeddedValueResolver != null) { initialDelayString = this.embeddedValueResolver.resolveStringValue(initialDelayString); } if (StringUtils.hasLength(initialDelayString)) { try { initialDelay = convertToMillis(initialDelayString, scheduled.timeUnit()); } catch (RuntimeException ex) { throw new IllegalArgumentException( \"Invalid initialDelayString value \\\"\" + initialDelayString + \"\\\" - cannot parse into long\"); } } } // Check cron expression String cron = scheduled.cron(); if (StringUtils.hasText(cron)) { String zone = scheduled.zone(); if (this.embeddedValueResolver != null) { cron = this.embeddedValueResolver.resolveStringValue(cron); zone = this.embeddedValueResolver.resolveStringValue(zone); } if (StringUtils.hasLength(cron)) { Assert.isTrue(initialDelay == -1, \"'initialDelay' not supported for cron triggers\"); processedSchedule = true; if (!Scheduled.CRON_DISABLED.equals(cron)) { TimeZone timeZone; if (StringUtils.hasText(zone)) { timeZone = StringUtils.parseTimeZoneString(zone); } else { timeZone = TimeZone.getDefault(); } tasks.add(this.registrar.scheduleCronTask(new CronTask(runnable, new CronTrigger(cron, timeZone)))); } } } // At this point we don't need to differentiate between initial delay set or not anymore if (initialDelay \u003c 0) { initialDelay = 0; } // Check fixed delay long fixedDelay = convertToMillis(scheduled.fixedDelay(), scheduled.timeUnit()); if (fixedDelay \u003e= 0) { Assert.isTrue(!processedSchedule, errorMessage); processedSchedule = true; tasks.add(this.registrar.scheduleFixedDelayTask(new FixedDelayTask(runnable, fixedDelay, initialDelay))); } String fixedDelayString = scheduled.fixedDelayString(); if (StringUtils.hasText(fixedDelayString)) { if (this.embeddedValueResolver != null) { fixedDelayString = this.embeddedValueResolver.resolveStringValue(fixedDelayString); } if (StringUtils.hasLength(fixedDelayString)) { Assert.isTrue(!processedSchedule, errorMessage); processedSchedule = true; try { fixedDelay = convertToMillis(fixedDelayString, scheduled.timeUnit()); } catch (RuntimeException ex) { throw new IllegalArgumentException( \"Invalid fixedDelayString value \\\"\" + fixedDelayString + \"\\\" - cannot parse into long\"); } tasks.add(this.registrar.scheduleFixedDelayTask(new FixedDelayTask(runnable, fixedDelay, initialDelay))); } } // Check fixed rate long fixedRate = convertToMillis(scheduled.fixedRate(), scheduled.timeUnit()); if (fixedRate \u003e= 0) { Assert.isTrue(!processedSchedule, errorMessage); processedSchedule = true; tasks.add(this.registrar.scheduleFixedRateTask(new FixedRateTask(runnable, fixedRate, initialDelay))); } String fixedRateString = scheduled.fixedRateString(); if (StringUtils.hasText(fixedRateString)) { if (this.embeddedValueResolver != null) { fixedRateString = this.embeddedValueResolver.resolveStringValue(fixedRateString); } if (StringUtils.hasLength(fixedRateString)) { Assert.isTrue(!processedSchedule, errorMessage); processedSchedule = true; try { fixedRate = convertToMillis(fixedRateString, scheduled.timeUnit()); } catch (RuntimeException ex) { throw new IllegalArgumentException( \"Invalid fixedRateString value \\\"\" + fixedRateString + \"\\\" - cannot parse into long\"); } tasks.add(this.registrar.scheduleFixedRateTask(new FixedRateTask(runnable, fixedRate, initialDelay))); } } // Check whether we had any attribute set Assert.isTrue(processedSchedule, errorMessage); // Finally register the scheduled tasks synchronized (this.scheduledTasks) { Set\u003cScheduledTask\u003e regTasks = this.scheduledTasks.computeIfAbsent(bean, key -\u003e new LinkedHashSet\u003c\u003e(4)); regTasks.addAll(tasks); } } catch (IllegalArgumentException ex) { throw new IllegalStateException( \"Encountered invalid @Scheduled method '\" + method.getName() + \"': \" + ex.getMessage()); } } /** * Create a {@link Runnable} for the given bean instance, * calling the specified scheduled method. * The default implementation creates a {@link ScheduledMethodRunnable}. * @param target the target bean instance * @param method the scheduled method to call * @since 5.1 * @see ScheduledMethodRunnable#ScheduledMethodRunnable(Object, Method) */ protected Runnable createRunnable(Object target, Method method) { Assert.isTrue(method.getParameterCount() == 0, \"Only no-arg methods may be annotated with @Scheduled\"); Method invocableMethod = AopUtils.selectInvocableMethod(method, target.getClass()); return new ScheduledMethodRunnable(target, invocableMethod); } private static long convertToMillis(long value, TimeUnit timeUnit) { return TimeUnit.MILLISECONDS.convert(value, timeUnit); } private static long convertToMillis(String value, TimeUnit timeUnit) { if (isDurationString(value)) { return Duration.parse(value).toMillis(); } return convertToMillis(Long.parseLong(value), timeUnit); } private static boolean isDurationString(String value) { return (value.length() \u003e 1 \u0026\u0026 (isP(value.charAt(0)) || isP(value.charAt(1)))); } private static boolean isP(char ch) { return (ch == 'P' || ch == 'p'); } /** * Return all currently scheduled tasks, from {@link Scheduled} methods * as well as from programmatic {@link SchedulingConfigurer} interaction. * @since 5.0.2 */ @Override public Set\u003cScheduledTask\u003e getScheduledTasks() { Set\u003cScheduledTask\u003e result = new LinkedHashSet\u003c\u003e(); synchronized (this.scheduledTasks) { Collection\u003cSet\u003cScheduledTask\u003e\u003e allTasks = this.scheduledTasks.values(); for (Set\u003cScheduledTask\u003e tasks : allTasks) { result.addAll(tasks); } } result.addAll(this.registrar.getScheduledTasks()); return result; } @Override public void postProcessBeforeDestruction(Object bean, String beanName) { Set\u003cScheduledTask\u003e tasks; synchronized (this.scheduledTasks) { tasks = this.scheduledTasks.remove(bean); } if (tasks != null) { for (ScheduledTask task : tasks) { task.cancel(); } } } @Override public boolean requiresDestruction(Object bean) { synchronized (this.scheduledTasks) { return this.scheduledTasks.containsKey(bean); } } @Override public void destroy() { synchronized (this.scheduledTasks) { Collection\u003cSet\u003cScheduledTask\u003e\u003e allTasks = this.scheduledTasks.values(); for (Set\u003cScheduledTask\u003e tasks : allTasks) { for (ScheduledTask task : tasks) { task.cancel(); } } this.scheduledTasks.clear(); } this.registrar.destroy(); } } 第二个关键类\n/** * Helper bean for registering tasks with a {@link TaskScheduler}, typically using cron * expressions. * * As of Spring 3.1, {@code ScheduledTaskRegistrar} has a more prominent user-facing * role when used in conjunction with the {@link * org.springframework.scheduling.annotation.EnableAsync @EnableAsync} annotation and its * {@link org.springframework.scheduling.annotation.SchedulingConfigurer * SchedulingConfigurer} callback interface. * * @author Juergen Hoeller * @author Chris Beams * @author Tobias Montagna-Hay * @author Sam Brannen * @since 3.0 * @see org.springframework.scheduling.annotation.EnableAsync * @see org.springframework.scheduling.annotation.SchedulingConfigurer */ public class ScheduledTaskRegistrar implements ScheduledTaskHolder, InitializingBean, DisposableBean { /** * A special cron expression value that indicates a disabled trigger: {@value}. * This is primarily meant for use with {@link #addCronTask(Runnable, String)} * when the value for the supplied {@code expression} is retrieved from an * external source \u0026mdash; for example, from a property in the * {@link org.springframework.core.env.Environment Environment}. * @since 5.2 * @see org.springframework.scheduling.annotation.Scheduled#CRON_DISABLED */ public static final String CRON_DISABLED = \"-\"; @Nullable private TaskScheduler taskScheduler; @Nullable private ScheduledExecutorService localExecutor; @Nullable private List\u003cTriggerTask\u003e triggerTasks; @Nullable private List\u003cCronTask\u003e cronTasks; @Nullable private List\u003cIntervalTask\u003e fixedRateTasks; @Nullable private List\u003cIntervalTask\u003e fixedDelayTasks; private final Map\u003cTask, ScheduledTask\u003e unresolvedTasks = new HashMap\u003c\u003e(16); private final Set\u003cScheduledTask\u003e scheduledTasks = new LinkedHashSet\u003c\u003e(16); /** * Set the {@link TaskScheduler} to register scheduled tasks with. */ public void setTaskScheduler(TaskScheduler taskScheduler) { Assert.notNull(taskScheduler, \"TaskScheduler must not be null\"); this.taskScheduler = taskScheduler; } /** * Set the {@link TaskScheduler} to register scheduled tasks with, or a * {@link java.util.concurrent.ScheduledExecutorService} to be wrapped as a * {@code TaskScheduler}. */ public void setScheduler(@Nullable Object scheduler) { if (scheduler == null) { this.taskScheduler = null; } else if (scheduler instanceof TaskScheduler) { this.taskScheduler = (TaskScheduler) scheduler; } else if (scheduler instanceof ScheduledExecutorService) { this.taskScheduler = new ConcurrentTaskScheduler(((ScheduledExecutorService) scheduler)); } else { throw new IllegalArgumentException(\"Unsupported scheduler type: \" + scheduler.getClass()); } } /** * Return the {@link TaskScheduler} instance for this registrar (may be {@code null}). */ @Nullable public TaskScheduler getScheduler() { return this.taskScheduler; } /** * Specify triggered tasks as a Map of Runnables (the tasks) and Trigger objects * (typically custom implementations of the {@link Trigger} interface). */ public void setTriggerTasks(Map\u003cRunnable, Trigger\u003e triggerTasks) { this.triggerTasks = new ArrayList\u003c\u003e(); triggerTasks.forEach((task, trigger) -\u003e addTriggerTask(new TriggerTask(task, trigger))); } /** * Specify triggered tasks as a list of {@link TriggerTask} objects. Primarily used * by {@code } namespace parsing. * @since 3.2 * @see ScheduledTasksBeanDefinitionParser */ public void setTriggerTasksList(List\u003cTriggerTask\u003e triggerTasks) { this.triggerTasks = triggerTasks; } /** * Get the trigger tasks as an unmodifiable list of {@link TriggerTask} objects. * @return the list of tasks (never {@code null}) * @since 4.2 */ public List\u003cTriggerTask\u003e getTriggerTaskList() { return (this.triggerTasks != null? Collections.unmodifiableList(this.triggerTasks) : Collections.emptyList()); } /** * Specify triggered tasks as a Map of Runnables (the tasks) and cron expressions. * @see CronTrigger */ public void setCronTasks(Map\u003cRunnable, String\u003e cronTasks) { this.cronTasks = new ArrayList\u003c\u003e(); cronTasks.forEach(this::addCronTask); } /** * Specify triggered tasks as a list of {@link CronTask} objects. Primarily used by * {@code } namespace parsing. * @since 3.2 * @see ScheduledTasksBeanDefinitionParser */ public void setCronTasksList(List\u003cCronTask\u003e cronTasks) { this.cronTasks = cronTasks; } /** * Get the cron tasks as an unmodifiable list of {@link CronTask} objects. * @return the list of tasks (never {@code null}) * @since 4.2 */ public List\u003cCronTask\u003e getCronTaskList() { return (this.cronTasks != null ? Collections.unmodifiableList(this.cronTasks) : Collections.emptyList()); } /** * Specify triggered tasks as a Map of Runnables (the tasks) and fixed-rate values. * @see TaskScheduler#scheduleAtFixedRate(Runnable, long) */ public void setFixedRateTasks(Map\u003cRunnable, Long\u003e fixedRateTasks) { this.fixedRateTasks = new ArrayList\u003c\u003e(); fixedRateTasks.forEach(this::addFixedRateTask); } /** * Specify fixed-rate tasks as a list of {@link IntervalTask} objects. Primarily used * by {@code } namespace parsing. * @since 3.2 * @see ScheduledTasksBeanDefinitionParser */ public void setFixedRateTasksList(List\u003cIntervalTask\u003e fixedRateTasks) { this.fixedRateTasks = fixedRateTasks; } /** * Get the fixed-rate tasks as an unmodifiable list of {@link IntervalTask} objects. * @return the list of tasks (never {@code null}) * @since 4.2 */ public List\u003cIntervalTask\u003e getFixedRateTaskList() { return (this.fixedRateTasks != null ? Collections.unmodifiableList(this.fixedRateTasks) : Collections.emptyList()); } /** * Specify triggered tasks as a Map of Runnables (the tasks) and fixed-delay values. * @see TaskScheduler#scheduleWithFixedDelay(Runnable, long) */ public void setFixedDelayTasks(Map\u003cRunnable, Long\u003e fixedDelayTasks) { this.fixedDelayTasks = new ArrayList\u003c\u003e(); fixedDelayTasks.forEach(this::addFixedDelayTask); } /** * Specify fixed-delay tasks as a list of {@link IntervalTask} objects. Primarily used * by {@code } namespace parsing. * @since 3.2 * @see ScheduledTasksBeanDefinitionParser */ public void setFixedDelayTasksList(List\u003cIntervalTask\u003e fixedDelayTasks) { this.fixedDelayTasks = fixedDelayTasks; } /** * Get the fixed-delay tasks as an unmodifiable list of {@link IntervalTask} objects. * @return the list of tasks (never {@code null}) * @since 4.2 */ public List\u003cIntervalTask\u003e getFixedDelayTaskList() { return (this.fixedDelayTasks != null ? Collections.unmodifiableList(this.fixedDelayTasks) : Collections.emptyList()); } /** * Add a Runnable task to be triggered per the given {@link Trigger}. * @see TaskScheduler#scheduleAtFixedRate(Runnable, long) */ public void addTriggerTask(Runnable task, Trigger trigger) { addTriggerTask(new TriggerTask(task, trigger)); } /** * Add a {@code TriggerTask}. * @since 3.2 * @see TaskScheduler#scheduleAtFixedRate(Runnable, long) */ public void addTriggerTask(TriggerTask task) { if (this.triggerTasks == null) { this.triggerTasks = new ArrayList\u003c\u003e(); } this.triggerTasks.add(task); } /** * Add a {@link Runnable} task to be triggered per the given cron {@code expression}. * As of Spring Framework 5.2, this method will not register the task if the * {@code expression} is equal to {@link #CRON_DISABLED}. */ public void addCronTask(Runnable task, String expression) { if (!CRON_DISABLED.equals(expression)) { addCronTask(new CronTask(task, expression)); } } /** * Add a {@link CronTask}. * @since 3.2 */ public void addCronTask(CronTask task) { if (this.cronTasks == null) { this.cronTasks = new ArrayList\u003c\u003e(); } this.cronTasks.add(task); } /** * Add a {@code Runnable} task to be triggered at the given fixed-rate interval. * @see TaskScheduler#scheduleAtFixedRate(Runnable, long) */ public void addFixedRateTask(Runnable task, long interval) { addFixedRateTask(new IntervalTask(task, interval, 0)); } /** * Add a fixed-rate {@link IntervalTask}. * @since 3.2 * @see TaskScheduler#scheduleAtFixedRate(Runnable, long) */ public void addFixedRateTask(IntervalTask task) { if (this.fixedRateTasks == null) { this.fixedRateTasks = new ArrayList\u003c\u003e(); } this.fixedRateTasks.add(task); } /** * Add a Runnable task to be triggered with the given fixed delay. * @see TaskScheduler#scheduleWithFixedDelay(Runnable, long) */ public void addFixedDelayTask(Runnable task, long delay) { addFixedDelayTask(new IntervalTask(task, delay, 0)); } /** * Add a fixed-delay {@link IntervalTask}. * @since 3.2 * @see TaskScheduler#scheduleWithFixedDelay(Runnable, long) */ public void addFixedDelayTask(IntervalTask task) { if (this.fixedDelayTasks == null) { this.fixedDelayTasks = new ArrayList\u003c\u003e(); } this.fixedDelayTasks.add(task); } /** * Return whether this {@code ScheduledTaskRegistrar} has any tasks registered. * @since 3.2 */ public boolean hasTasks() { return (!CollectionUtils.isEmpty(this.triggerTasks) || !CollectionUtils.isEmpty(this.cronTasks) || !CollectionUtils.isEmpty(this.fixedRateTasks) || !CollectionUtils.isEmpty(this.fixedDelayTasks)); } /** * Calls {@link #scheduleTasks()} at bean construction time. */ @Override public void afterPropertiesSet() { scheduleTasks(); } /** * Schedule all registered tasks against the underlying * {@linkplain #setTaskScheduler(TaskScheduler) task scheduler}. */ @SuppressWarnings(\"deprecation\") protected void scheduleTasks() { if (this.taskScheduler == null) { this.localExecutor = Executors.newSingleThreadScheduledExecutor(); this.taskScheduler = new ConcurrentTaskScheduler(this.localExecutor); } if (this.triggerTasks != null) { for (TriggerTask task : this.triggerTasks) { addScheduledTask(scheduleTriggerTask(task)); } } if (this.cronTasks != null) { for (CronTask task : this.cronTasks) { addScheduledTask(scheduleCronTask(task)); } } if (this.fixedRateTasks != null) { for (IntervalTask task : this.fixedRateTasks) { addScheduledTask(scheduleFixedRateTask(task)); } } if (this.fixedDelayTasks != null) { for (IntervalTask task : this.fixedDelayTasks) { addScheduledTask(scheduleFixedDelayTask(task)); } } } private void addScheduledTask(@Nullable ScheduledTask task) { if (task != null) { this.scheduledTasks.add(task); } } /** * Schedule the specified trigger task, either right away if possible * or on initialization of the scheduler. * @return a handle to the scheduled task, allowing to cancel it * @since 4.3 */ @Nullable public ScheduledTask scheduleTriggerTask(TriggerTask task) { ScheduledTask scheduledTask = this.unresolvedTasks.remove(task); boolean newTask = false; if (scheduledTask == null) { scheduledTask = new ScheduledTask(task); newTask = true; } if (this.taskScheduler != null) { scheduledTask.future = this.taskScheduler.schedule(task.getRunnable(), task.getTrigger()); } else { addTriggerTask(task); this.unresolvedTasks.put(task, scheduledTask); } return (newTask ? scheduledTask : null); } /** * Schedule the specified cron task, either right away if possible * or on initialization of the scheduler. * @return a handle to the scheduled task, allowing to cancel it * (or {@code null} if processing a previously registered task) * @since 4.3 */ @Nullable public ScheduledTask scheduleCronTask(CronTask task) { ScheduledTask scheduledTask = this.unresolvedTasks.remove(task); boolean newTask = false; if (scheduledTask == null) { scheduledTask = new ScheduledTask(task); newTask = true; } if (this.taskScheduler != null) { scheduledTask.future = this.taskScheduler.schedule(task.getRunnable(), task.getTrigger()); } else { addCronTask(task); this.unresolvedTasks.put(task, scheduledTask); } return (newTask ? scheduledTask : null); } /** * Schedule the specified fixed-rate task, either right away if possible * or on initialization of the scheduler. * @return a handle to the scheduled task, allowing to cancel it * (or {@code null} if processing a previously registered task) * @since 4.3 * @deprecated as of 5.0.2, in favor of {@link #scheduleFixedRateTask(FixedRateTask)} */ @Deprecated @Nullable public ScheduledTask scheduleFixedRateTask(IntervalTask task) { FixedRateTask taskToUse = (task instanceof FixedRateTask ? (FixedRateTask) task : new FixedRateTask(task.getRunnable(), task.getInterval(), task.getInitialDelay())); return scheduleFixedRateTask(taskToUse); } /** * Schedule the specified fixed-rate task, either right away if possible * or on initialization of the scheduler. * @return a handle to the scheduled task, allowing to cancel it * (or {@code null} if processing a previously registered task) * @since 5.0.2 */ @Nullable public ScheduledTask scheduleFixedRateTask(FixedRateTask task) { ScheduledTask scheduledTask = this.unresolvedTasks.remove(task); boolean newTask = false; if (scheduledTask == null) { scheduledTask = new ScheduledTask(task); newTask = true; } if (this.taskScheduler != null) { if (task.getInitialDelay() \u003e 0) { Date startTime = new Date(this.taskScheduler.getClock().millis() + task.getInitialDelay()); scheduledTask.future = this.taskScheduler.scheduleAtFixedRate(task.getRunnable(), startTime, task.getInterval()); } else { scheduledTask.future = this.taskScheduler.scheduleAtFixedRate(task.getRunnable(), task.getInterval()); } } else { addFixedRateTask(task); this.unresolvedTasks.put(task, scheduledTask); } return (newTask ? scheduledTask : null); } /** * Schedule the specified fixed-delay task, either right away if possible * or on initialization of the scheduler. * @return a handle to the scheduled task, allowing to cancel it * (or {@code null} if processing a previously registered task) * @since 4.3 * @deprecated as of 5.0.2, in favor of {@link #scheduleFixedDelayTask(FixedDelayTask)} */ @Deprecated @Nullable public ScheduledTask scheduleFixedDelayTask(IntervalTask task) { FixedDelayTask taskToUse = (task instanceof FixedDelayTask ? (FixedDelayTask) task : new FixedDelayTask(task.getRunnable(), task.getInterval(), task.getInitialDelay())); return scheduleFixedDelayTask(taskToUse); } /** * Schedule the specified fixed-delay task, either right away if possible * or on initialization of the scheduler. * @return a handle to the scheduled task, allowing to cancel it * (or {@code null} if processing a previously registered task) * @since 5.0.2 */ @Nullable public ScheduledTask scheduleFixedDelayTask(FixedDelayTask task) { ScheduledTask scheduledTask = this.unresolvedTasks.remove(task); boolean newTask = false; if (scheduledTask == null) { scheduledTask = new ScheduledTask(task); newTask = true; } if (this.taskScheduler != null) { if (task.getInitialDelay() \u003e 0) { Date startTime = new Date(this.taskScheduler.getClock().millis() + task.getInitialDelay()); scheduledTask.future = this.taskScheduler.scheduleWithFixedDelay(task.getRunnable(), startTime, task.getInterval()); } else { scheduledTask.future = this.taskScheduler.scheduleWithFixedDelay(task.getRunnable(), task.getInterval()); } } else { addFixedDelayTask(task); this.unresolvedTasks.put(task, scheduledTask); } return (newTask ? scheduledTask : null); } /** * Return all locally registered tasks that have been scheduled by this registrar. * @since 5.0.2 * @see #addTriggerTask * @see #addCronTask * @see #addFixedRateTask * @see #addFixedDelayTask */ @Override public Set\u003cScheduledTask\u003e getScheduledTasks() { return Collections.unmodifiableSet(this.scheduledTasks); } @Override public void destroy() { for (ScheduledTask task : this.scheduledTasks) { task.cancel(); } if (this.localExecutor != null) { this.localExecutor.shutdownNow(); } } } 拓展应用 ","wordCount":"4846","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.catguild.cn/posts/spring%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"},"publisher":{"@type":"Organization","name":"猫公会","logo":{"@type":"ImageObject","url":"https://www.catguild.cn/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.catguild.cn/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.catguild.cn/archives/ title=⏱时间轴><span>⏱时间轴</span></a></li><li><a href=https://www.catguild.cn/categories/ title=分类><span>分类</span></a></li><li><a href=https://www.catguild.cn/tags/ title=🔖标签><span>🔖标签</span></a></li><li><a href=https://www.catguild.cn/search/ title="🔍搜索 (Alt + /)" accesskey=/><span>🔍搜索</span></a></li><li><a href=https://www.catguild.cn/links/ title=🤝友链><span>🤝友链</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.catguild.cn/>Home</a>&nbsp;»&nbsp;<a href=https://www.catguild.cn/posts/>Posts</a></div><h1 class=post-title>Spring Task定时任务</h1><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>0001-01-01
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>4846字
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>10分钟
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span></span></span></span><span style=opacity:.8><span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span>
<span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>
&nbsp;&nbsp;</span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录导航</span></summary><div class=inner><ul><li><a href=#%e5%88%9d%e8%ae%a4%e8%af%86 aria-label=初认识>初认识</a><ul><li><a href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8 aria-label=基本使用>基本使用</a><ul><ul><li><a href=#1%e6%b7%bb%e5%8a%a0%e5%9f%ba%e6%9c%ac%e4%be%9d%e8%b5%96 aria-label=1、添加基本依赖>1、添加基本依赖</a></li><li><a href=#2 aria-label=2、>2、</a></li></ul></ul></li><li><a href=#%e4%b8%89%e7%a7%8d%e8%a7%a6%e5%8f%91%e5%99%a8 aria-label=三种触发器>三种触发器</a><ul><li><a href=#%e5%ae%9e%e9%99%85%e8%bf%90%e8%a1%8c%e4%b8%80%e4%b8%8b aria-label=实际运行一下>实际运行一下</a></li><li><a href=#%e4%b8%ba%e4%bb%80%e4%b9%88%e4%bc%9a%e8%bf%99%e6%a0%b7 aria-label=为什么会这样>为什么会这样</a></li></ul></li></ul></li><li><a href=#%e8%bf%90%e8%a1%8c%e5%8e%9f%e7%90%86 aria-label=运行原理>运行原理</a></li><li><a href=#%e6%8b%93%e5%b1%95%e5%ba%94%e7%94%a8 aria-label=拓展应用>拓展应用</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=初认识>初认识<a hidden class=anchor aria-hidden=true href=#初认识>#</a></h1><h2 id=基本使用>基本使用<a hidden class=anchor aria-hidden=true href=#基本使用>#</a></h2><h4 id=1添加基本依赖>1、添加基本依赖<a hidden class=anchor aria-hidden=true href=#1添加基本依赖>#</a></h4><h4 id=2>2、<a hidden class=anchor aria-hidden=true href=#2>#</a></h4><p>@EnableScheduling 注解开启定时任务</p><p>@Scheduled 注释标注定时任务方法</p><p>通过注册ScheduledAnnotationBeanPostProcessor来执行@Scheduled注释的处理。这可以手动完成，或者更方便地通过<a href=task:annotation-driven/>task:annotation-driven/</a>XML元素或@EnableScheduling annotation来完成。</p><h2 id=三种触发器>三种触发器<a hidden class=anchor aria-hidden=true href=#三种触发器>#</a></h2><h3 id=实际运行一下>实际运行一下<a hidden class=anchor aria-hidden=true href=#实际运行一下>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>lombok.extern.slf4j.Slf4j</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.scheduling.annotation.EnableScheduling</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.scheduling.annotation.Scheduled</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>org.springframework.stereotype.Component</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * @author xiyan
</span></span></span><span class=line><span class=cl><span class=cm> * @date 2023/7/5 14:36
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=nd>@Slf4j</span>
</span></span><span class=line><span class=cl><span class=nd>@EnableScheduling</span>
</span></span><span class=line><span class=cl><span class=nd>@Component</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DemoScheduledTest</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 固定延迟时间
</span></span></span><span class=line><span class=cl><span class=cm>     * 间隔 5s ，执行 3s、实际间隔8s
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:36:05.068
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:36:13.091
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:36:21.109
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:36:29.134
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:36:37.149
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * 间隔 5s ，执行 5s、实际间隔10s
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:38:46.182
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:38:56.196
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:39:06.210
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:39:16.235
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:39:26.244
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * 间隔 5s ，执行 7s、实际间隔12s
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:45:02.764
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:45:14.775
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:45:26.796
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:45:38.814
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:45:50.830
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * 下次执行时间=上次执行时间+(fixedDelay时间+执行耗时)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Scheduled</span><span class=o>(</span><span class=n>fixedDelay</span> <span class=o>=</span> <span class=mi>5000</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test1</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;test1方法执行=====&gt;&gt;&gt;&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>3000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 固定间隔时间
</span></span></span><span class=line><span class=cl><span class=cm>     * 间隔5s、执行3s、实际间隔5s
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 18:00:11.362
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 18:00:16.352
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 18:00:21.358
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 18:00:26.355
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 18:00:31.364
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * 间隔 5s ，执行 5s、实际间隔5s
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:40:39.180
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:40:44.185
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:40:49.200
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:40:54.212
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:40:59.226
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * 间隔5s，执行7s、实际间隔7s
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:41:45.559
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:41:52.567
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:41:59.581
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:42:06.588
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-05 14:42:13.593
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * 下次执行时间=上次执行时间+ max(fixedRate, 执行耗时)
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Scheduled</span><span class=o>(</span><span class=n>fixedRate</span> <span class=o>=</span> <span class=mi>5000</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test2</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;test2方法执行=====&gt;&gt;&gt;&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>3000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * cron表达式
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * 间隔5s、执行3s、实际间隔5s
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:55:10.015
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:55:15.001
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:55:20.014
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:55:25.007
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:55:30.008
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * 间隔 5s ，执行 5s、实际间隔10s
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:49:55.008
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:50:05.014
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:50:15.000
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:50:25.004
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:50:35.005
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * 间隔5s，执行7s、实际间隔10s
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:51:55.016
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:52:05.008
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:52:15.001
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:52:25.010
</span></span></span><span class=line><span class=cl><span class=cm>     * 2023-07-06 17:52:35.014
</span></span></span><span class=line><span class=cl><span class=cm>     * &lt;p&gt;
</span></span></span><span class=line><span class=cl><span class=cm>     * 下次执行时间=如果到达定时时间，上一个任务已完成，将会执行，否则会跳过
</span></span></span><span class=line><span class=cl><span class=cm>     */</span>
</span></span><span class=line><span class=cl>    <span class=nd>@Scheduled</span><span class=o>(</span><span class=n>cron</span> <span class=o>=</span> <span class=s>&#34;0/5 * * * * ?&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>test3</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;test3方法执行=====&gt;&gt;&gt;&gt;&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=mi>5000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=o>(</span><span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h3 id=为什么会这样>为什么会这样<a hidden class=anchor aria-hidden=true href=#为什么会这样>#</a></h3><h1 id=运行原理>运行原理<a hidden class=anchor aria-hidden=true href=#运行原理>#</a></h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>Bean后处理器，注册用@Scheduled注释的方法，以便由TaskScheduler根据通过注释提供的“fixedRate”、“fixedDelay”或“cron”表达式调用。
</span></span></span><span class=line><span class=cl><span class=cm>这个后处理器由Spring的&lt;task:annotation-driven&gt;XML元素以及@EnableScheduling注释自动注册。
</span></span></span><span class=line><span class=cl><span class=cm>自动检测容器中的任何SchedulingConfigurer实例，允许自定义要使用的计划程序或对任务注册进行细粒度控制（例如，注册触发器任务）。
</span></span></span><span class=line><span class=cl><span class=cm>*/</span>
</span></span><span class=line><span class=cl><span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>scheduling</span><span class=o>.</span><span class=na>annotation</span><span class=o>.</span><span class=na>ScheduledAnnotationBeanPostProcessor</span>
</span></span></code></pre></div><p>关键类</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Bean post-processor that registers methods annotated with
</span></span></span><span class=line><span class=cl><span class=cm> * {@link Scheduled @Scheduled} to be invoked by a
</span></span></span><span class=line><span class=cl><span class=cm> * {@link org.springframework.scheduling.TaskScheduler} according to the
</span></span></span><span class=line><span class=cl><span class=cm> * &#34;fixedRate&#34;, &#34;fixedDelay&#34;, or &#34;cron&#34; expression provided via the annotation.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;p&gt;This post-processor is automatically registered by Spring&#39;s
</span></span></span><span class=line><span class=cl><span class=cm> * {@code &lt;task:annotation-driven&gt;} XML element, and also by the
</span></span></span><span class=line><span class=cl><span class=cm> * {@link EnableScheduling @EnableScheduling} annotation.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;p&gt;Autodetects any {@link SchedulingConfigurer} instances in the container,
</span></span></span><span class=line><span class=cl><span class=cm> * allowing for customization of the scheduler to be used or for fine-grained
</span></span></span><span class=line><span class=cl><span class=cm> * control over task registration (e.g. registration of {@link Trigger} tasks).
</span></span></span><span class=line><span class=cl><span class=cm> * See the {@link EnableScheduling @EnableScheduling} javadocs for complete usage
</span></span></span><span class=line><span class=cl><span class=cm> * details.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @author Mark Fisher
</span></span></span><span class=line><span class=cl><span class=cm> * @author Juergen Hoeller
</span></span></span><span class=line><span class=cl><span class=cm> * @author Chris Beams
</span></span></span><span class=line><span class=cl><span class=cm> * @author Elizabeth Chatman
</span></span></span><span class=line><span class=cl><span class=cm> * @author Victor Brown
</span></span></span><span class=line><span class=cl><span class=cm> * @author Sam Brannen
</span></span></span><span class=line><span class=cl><span class=cm> * @since 3.0
</span></span></span><span class=line><span class=cl><span class=cm> * @see Scheduled
</span></span></span><span class=line><span class=cl><span class=cm> * @see EnableScheduling
</span></span></span><span class=line><span class=cl><span class=cm> * @see SchedulingConfigurer
</span></span></span><span class=line><span class=cl><span class=cm> * @see org.springframework.scheduling.TaskScheduler
</span></span></span><span class=line><span class=cl><span class=cm> * @see org.springframework.scheduling.config.ScheduledTaskRegistrar
</span></span></span><span class=line><span class=cl><span class=cm> * @see AsyncAnnotationBeanPostProcessor
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ScheduledAnnotationBeanPostProcessor</span>
</span></span><span class=line><span class=cl>		<span class=kd>implements</span> <span class=n>ScheduledTaskHolder</span><span class=o>,</span> <span class=n>MergedBeanDefinitionPostProcessor</span><span class=o>,</span> <span class=n>DestructionAwareBeanPostProcessor</span><span class=o>,</span>
</span></span><span class=line><span class=cl>		<span class=n>Ordered</span><span class=o>,</span> <span class=n>EmbeddedValueResolverAware</span><span class=o>,</span> <span class=n>BeanNameAware</span><span class=o>,</span> <span class=n>BeanFactoryAware</span><span class=o>,</span> <span class=n>ApplicationContextAware</span><span class=o>,</span>
</span></span><span class=line><span class=cl>		<span class=n>SmartInitializingSingleton</span><span class=o>,</span> <span class=n>ApplicationListener</span><span class=o>&lt;</span><span class=n>ContextRefreshedEvent</span><span class=o>&gt;,</span> <span class=n>DisposableBean</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * The default name of the {@link TaskScheduler} bean to pick up: {@value}.
</span></span></span><span class=line><span class=cl><span class=cm>	 * &lt;p&gt;Note that the initial lookup happens by type; this is just the fallback
</span></span></span><span class=line><span class=cl><span class=cm>	 * in case of multiple scheduler beans found in the context.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 4.2
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>DEFAULT_TASK_SCHEDULER_BEAN_NAME</span> <span class=o>=</span> <span class=s>&#34;taskScheduler&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>protected</span> <span class=kd>final</span> <span class=n>Log</span> <span class=n>logger</span> <span class=o>=</span> <span class=n>LogFactory</span><span class=o>.</span><span class=na>getLog</span><span class=o>(</span><span class=n>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>ScheduledTaskRegistrar</span> <span class=n>registrar</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=n>Object</span> <span class=n>scheduler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=n>StringValueResolver</span> <span class=n>embeddedValueResolver</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=n>String</span> <span class=n>beanName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=n>BeanFactory</span> <span class=n>beanFactory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=n>ApplicationContext</span> <span class=n>applicationContext</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>nonAnnotatedClasses</span> <span class=o>=</span> <span class=n>Collections</span><span class=o>.</span><span class=na>newSetFromMap</span><span class=o>(</span><span class=k>new</span> <span class=n>ConcurrentHashMap</span><span class=o>&lt;&gt;(</span><span class=mi>64</span><span class=o>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>,</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>ScheduledTask</span><span class=o>&gt;&gt;</span> <span class=n>scheduledTasks</span> <span class=o>=</span> <span class=k>new</span> <span class=n>IdentityHashMap</span><span class=o>&lt;&gt;(</span><span class=mi>16</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Create a default {@code ScheduledAnnotationBeanPostProcessor}.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=nf>ScheduledAnnotationBeanPostProcessor</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>registrar</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ScheduledTaskRegistrar</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Create a {@code ScheduledAnnotationBeanPostProcessor} delegating to the
</span></span></span><span class=line><span class=cl><span class=cm>	 * specified {@link ScheduledTaskRegistrar}.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @param registrar the ScheduledTaskRegistrar to register {@code @Scheduled}
</span></span></span><span class=line><span class=cl><span class=cm>	 * tasks on
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 5.1
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=nf>ScheduledAnnotationBeanPostProcessor</span><span class=o>(</span><span class=n>ScheduledTaskRegistrar</span> <span class=n>registrar</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>Assert</span><span class=o>.</span><span class=na>notNull</span><span class=o>(</span><span class=n>registrar</span><span class=o>,</span> <span class=s>&#34;ScheduledTaskRegistrar is required&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>registrar</span> <span class=o>=</span> <span class=n>registrar</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>int</span> <span class=nf>getOrder</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>LOWEST_PRECEDENCE</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Set the {@link org.springframework.scheduling.TaskScheduler} that will invoke
</span></span></span><span class=line><span class=cl><span class=cm>	 * the scheduled methods, or a {@link java.util.concurrent.ScheduledExecutorService}
</span></span></span><span class=line><span class=cl><span class=cm>	 * to be wrapped as a TaskScheduler.
</span></span></span><span class=line><span class=cl><span class=cm>	 * &lt;p&gt;If not specified, default scheduler resolution will apply: searching for a
</span></span></span><span class=line><span class=cl><span class=cm>	 * unique {@link TaskScheduler} bean in the context, or for a {@link TaskScheduler}
</span></span></span><span class=line><span class=cl><span class=cm>	 * bean named &#34;taskScheduler&#34; otherwise; the same lookup will also be performed for
</span></span></span><span class=line><span class=cl><span class=cm>	 * a {@link ScheduledExecutorService} bean. If neither of the two is resolvable,
</span></span></span><span class=line><span class=cl><span class=cm>	 * a local single-threaded default scheduler will be created within the registrar.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see #DEFAULT_TASK_SCHEDULER_BEAN_NAME
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setScheduler</span><span class=o>(</span><span class=n>Object</span> <span class=n>scheduler</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>scheduler</span> <span class=o>=</span> <span class=n>scheduler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setEmbeddedValueResolver</span><span class=o>(</span><span class=n>StringValueResolver</span> <span class=n>resolver</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>embeddedValueResolver</span> <span class=o>=</span> <span class=n>resolver</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setBeanName</span><span class=o>(</span><span class=n>String</span> <span class=n>beanName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>beanName</span> <span class=o>=</span> <span class=n>beanName</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Making a {@link BeanFactory} available is optional; if not set,
</span></span></span><span class=line><span class=cl><span class=cm>	 * {@link SchedulingConfigurer} beans won&#39;t get autodetected and
</span></span></span><span class=line><span class=cl><span class=cm>	 * a {@link #setScheduler scheduler} has to be explicitly configured.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setBeanFactory</span><span class=o>(</span><span class=n>BeanFactory</span> <span class=n>beanFactory</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span> <span class=o>=</span> <span class=n>beanFactory</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Setting an {@link ApplicationContext} is optional: If set, registered
</span></span></span><span class=line><span class=cl><span class=cm>	 * tasks will be activated in the {@link ContextRefreshedEvent} phase;
</span></span></span><span class=line><span class=cl><span class=cm>	 * if not set, it will happen at {@link #afterSingletonsInstantiated} time.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setApplicationContext</span><span class=o>(</span><span class=n>ApplicationContext</span> <span class=n>applicationContext</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>applicationContext</span> <span class=o>=</span> <span class=n>applicationContext</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span> <span class=o>=</span> <span class=n>applicationContext</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>afterSingletonsInstantiated</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// Remove resolved singleton classes from cache
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>this</span><span class=o>.</span><span class=na>nonAnnotatedClasses</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>applicationContext</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Not running in an ApplicationContext -&gt; register tasks early...
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=n>finishRegistration</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>onApplicationEvent</span><span class=o>(</span><span class=n>ContextRefreshedEvent</span> <span class=n>event</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>event</span><span class=o>.</span><span class=na>getApplicationContext</span><span class=o>()</span> <span class=o>==</span> <span class=k>this</span><span class=o>.</span><span class=na>applicationContext</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Running in an ApplicationContext -&gt; register tasks this late...
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// giving other ContextRefreshedEvent listeners a chance to perform
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=c1>// their work at the same time (e.g. Spring Batch&#39;s job registration).
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=n>finishRegistration</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * 关键的注册逻辑
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kt>void</span> <span class=nf>finishRegistration</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>scheduler</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>setScheduler</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>scheduler</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>		<span class=c1>// 解析实现了 SchedulingConfigurer 接口的注册类，编程式任务注册
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span> <span class=k>instanceof</span> <span class=n>ListableBeanFactory</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>SchedulingConfigurer</span><span class=o>&gt;</span> <span class=n>beans</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>					<span class=o>((</span><span class=n>ListableBeanFactory</span><span class=o>)</span> <span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span><span class=o>).</span><span class=na>getBeansOfType</span><span class=o>(</span><span class=n>SchedulingConfigurer</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>List</span><span class=o>&lt;</span><span class=n>SchedulingConfigurer</span><span class=o>&gt;</span> <span class=n>configurers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;(</span><span class=n>beans</span><span class=o>.</span><span class=na>values</span><span class=o>());</span>
</span></span><span class=line><span class=cl>			<span class=n>AnnotationAwareOrderComparator</span><span class=o>.</span><span class=na>sort</span><span class=o>(</span><span class=n>configurers</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=o>(</span><span class=n>SchedulingConfigurer</span> <span class=n>configurer</span> <span class=o>:</span> <span class=n>configurers</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>configurer</span><span class=o>.</span><span class=na>configureTasks</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>        <span class=c1>// 如果注册器中有任务，则注册任务
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>hasTasks</span><span class=o>()</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>getScheduler</span><span class=o>()</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>Assert</span><span class=o>.</span><span class=na>state</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>,</span> <span class=s>&#34;BeanFactory must be set to find scheduler by type&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Search for TaskScheduler bean...
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>setTaskScheduler</span><span class=o>(</span><span class=n>resolveSchedulerBean</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span><span class=o>,</span> <span class=n>TaskScheduler</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kc>false</span><span class=o>));</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=k>catch</span> <span class=o>(</span><span class=n>NoUniqueBeanDefinitionException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isTraceEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>logger</span><span class=o>.</span><span class=na>trace</span><span class=o>(</span><span class=s>&#34;Could not find unique TaskScheduler bean - attempting to resolve by name: &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>							<span class=n>ex</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>setTaskScheduler</span><span class=o>(</span><span class=n>resolveSchedulerBean</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span><span class=o>,</span> <span class=n>TaskScheduler</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kc>true</span><span class=o>));</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=k>catch</span> <span class=o>(</span><span class=n>NoSuchBeanDefinitionException</span> <span class=n>ex2</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isInfoEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;More than one TaskScheduler bean exists within the context, and &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>								<span class=s>&#34;none is named &#39;taskScheduler&#39;. Mark one of them as primary or name it &#39;taskScheduler&#39; &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>								<span class=s>&#34;(possibly as an alias); or implement the SchedulingConfigurer interface and call &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>								<span class=s>&#34;ScheduledTaskRegistrar#setScheduler explicitly within the configureTasks() callback: &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>								<span class=n>ex</span><span class=o>.</span><span class=na>getBeanNamesFound</span><span class=o>());</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=k>catch</span> <span class=o>(</span><span class=n>NoSuchBeanDefinitionException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isTraceEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>logger</span><span class=o>.</span><span class=na>trace</span><span class=o>(</span><span class=s>&#34;Could not find default TaskScheduler bean - attempting to find ScheduledExecutorService: &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>							<span class=n>ex</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Search for ScheduledExecutorService bean next...
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>setScheduler</span><span class=o>(</span><span class=n>resolveSchedulerBean</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span><span class=o>,</span> <span class=n>ScheduledExecutorService</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kc>false</span><span class=o>));</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=k>catch</span> <span class=o>(</span><span class=n>NoUniqueBeanDefinitionException</span> <span class=n>ex2</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isTraceEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=n>logger</span><span class=o>.</span><span class=na>trace</span><span class=o>(</span><span class=s>&#34;Could not find unique ScheduledExecutorService bean - attempting to resolve by name: &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>								<span class=n>ex2</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>					<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>setScheduler</span><span class=o>(</span><span class=n>resolveSchedulerBean</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span><span class=o>,</span> <span class=n>ScheduledExecutorService</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=kc>true</span><span class=o>));</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>					<span class=k>catch</span> <span class=o>(</span><span class=n>NoSuchBeanDefinitionException</span> <span class=n>ex3</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isInfoEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>							<span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;More than one ScheduledExecutorService bean exists within the context, and &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>									<span class=s>&#34;none is named &#39;taskScheduler&#39;. Mark one of them as primary or name it &#39;taskScheduler&#39; &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>									<span class=s>&#34;(possibly as an alias); or implement the SchedulingConfigurer interface and call &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>									<span class=s>&#34;ScheduledTaskRegistrar#setScheduler explicitly within the configureTasks() callback: &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>									<span class=n>ex2</span><span class=o>.</span><span class=na>getBeanNamesFound</span><span class=o>());</span>
</span></span><span class=line><span class=cl>						<span class=o>}</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=k>catch</span> <span class=o>(</span><span class=n>NoSuchBeanDefinitionException</span> <span class=n>ex2</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isTraceEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=n>logger</span><span class=o>.</span><span class=na>trace</span><span class=o>(</span><span class=s>&#34;Could not find default ScheduledExecutorService bean - falling back to default: &#34;</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>								<span class=n>ex2</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>					<span class=c1>// Giving up -&gt; falling back to default scheduler within the registrar...
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;No TaskScheduler/ScheduledExecutorService bean found for scheduled processing&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>afterPropertiesSet</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>resolveSchedulerBean</span><span class=o>(</span><span class=n>BeanFactory</span> <span class=n>beanFactory</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>schedulerType</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>byName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>byName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>T</span> <span class=n>scheduler</span> <span class=o>=</span> <span class=n>beanFactory</span><span class=o>.</span><span class=na>getBean</span><span class=o>(</span><span class=n>DEFAULT_TASK_SCHEDULER_BEAN_NAME</span><span class=o>,</span> <span class=n>schedulerType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>beanName</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span> <span class=k>instanceof</span> <span class=n>ConfigurableBeanFactory</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=o>((</span><span class=n>ConfigurableBeanFactory</span><span class=o>)</span> <span class=k>this</span><span class=o>.</span><span class=na>beanFactory</span><span class=o>).</span><span class=na>registerDependentBean</span><span class=o>(</span>
</span></span><span class=line><span class=cl>						<span class=n>DEFAULT_TASK_SCHEDULER_BEAN_NAME</span><span class=o>,</span> <span class=k>this</span><span class=o>.</span><span class=na>beanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>scheduler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>beanFactory</span> <span class=k>instanceof</span> <span class=n>AutowireCapableBeanFactory</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>NamedBeanHolder</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>holder</span> <span class=o>=</span> <span class=o>((</span><span class=n>AutowireCapableBeanFactory</span><span class=o>)</span> <span class=n>beanFactory</span><span class=o>).</span><span class=na>resolveNamedBean</span><span class=o>(</span><span class=n>schedulerType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>beanName</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>beanFactory</span> <span class=k>instanceof</span> <span class=n>ConfigurableBeanFactory</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=o>((</span><span class=n>ConfigurableBeanFactory</span><span class=o>)</span> <span class=n>beanFactory</span><span class=o>).</span><span class=na>registerDependentBean</span><span class=o>(</span><span class=n>holder</span><span class=o>.</span><span class=na>getBeanName</span><span class=o>(),</span> <span class=k>this</span><span class=o>.</span><span class=na>beanName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>holder</span><span class=o>.</span><span class=na>getBeanInstance</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>beanFactory</span><span class=o>.</span><span class=na>getBean</span><span class=o>(</span><span class=n>schedulerType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>postProcessMergedBeanDefinition</span><span class=o>(</span><span class=n>RootBeanDefinition</span> <span class=n>beanDefinition</span><span class=o>,</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>beanType</span><span class=o>,</span> <span class=n>String</span> <span class=n>beanName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>Object</span> <span class=nf>postProcessBeforeInitialization</span><span class=o>(</span><span class=n>Object</span> <span class=n>bean</span><span class=o>,</span> <span class=n>String</span> <span class=n>beanName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>bean</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>Object</span> <span class=nf>postProcessAfterInitialization</span><span class=o>(</span><span class=n>Object</span> <span class=n>bean</span><span class=o>,</span> <span class=n>String</span> <span class=n>beanName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>bean</span> <span class=k>instanceof</span> <span class=n>AopInfrastructureBean</span> <span class=o>||</span> <span class=n>bean</span> <span class=k>instanceof</span> <span class=n>TaskScheduler</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>				<span class=n>bean</span> <span class=k>instanceof</span> <span class=n>ScheduledExecutorService</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// Ignore AOP infrastructure such as scoped proxies.
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>return</span> <span class=n>bean</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>targetClass</span> <span class=o>=</span> <span class=n>AopProxyUtils</span><span class=o>.</span><span class=na>ultimateTargetClass</span><span class=o>(</span><span class=n>bean</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(!</span><span class=k>this</span><span class=o>.</span><span class=na>nonAnnotatedClasses</span><span class=o>.</span><span class=na>contains</span><span class=o>(</span><span class=n>targetClass</span><span class=o>)</span> <span class=o>&amp;&amp;</span>
</span></span><span class=line><span class=cl>				<span class=n>AnnotationUtils</span><span class=o>.</span><span class=na>isCandidateClass</span><span class=o>(</span><span class=n>targetClass</span><span class=o>,</span> <span class=n>Arrays</span><span class=o>.</span><span class=na>asList</span><span class=o>(</span><span class=n>Scheduled</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>Schedules</span><span class=o>.</span><span class=na>class</span><span class=o>)))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>Map</span><span class=o>&lt;</span><span class=n>Method</span><span class=o>,</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>Scheduled</span><span class=o>&gt;&gt;</span> <span class=n>annotatedMethods</span> <span class=o>=</span> <span class=n>MethodIntrospector</span><span class=o>.</span><span class=na>selectMethods</span><span class=o>(</span><span class=n>targetClass</span><span class=o>,</span>
</span></span><span class=line><span class=cl>					<span class=o>(</span><span class=n>MethodIntrospector</span><span class=o>.</span><span class=na>MetadataLookup</span><span class=o>&lt;</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>Scheduled</span><span class=o>&gt;&gt;)</span> <span class=n>method</span> <span class=o>-&gt;</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=n>Set</span><span class=o>&lt;</span><span class=n>Scheduled</span><span class=o>&gt;</span> <span class=n>scheduledAnnotations</span> <span class=o>=</span> <span class=n>AnnotatedElementUtils</span><span class=o>.</span><span class=na>getMergedRepeatableAnnotations</span><span class=o>(</span>
</span></span><span class=line><span class=cl>								<span class=n>method</span><span class=o>,</span> <span class=n>Scheduled</span><span class=o>.</span><span class=na>class</span><span class=o>,</span> <span class=n>Schedules</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</span></span><span class=line><span class=cl>						<span class=k>return</span> <span class=o>(!</span><span class=n>scheduledAnnotations</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>()</span> <span class=o>?</span> <span class=n>scheduledAnnotations</span> <span class=o>:</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>					<span class=o>});</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>annotatedMethods</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>this</span><span class=o>.</span><span class=na>nonAnnotatedClasses</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>targetClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isTraceEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>logger</span><span class=o>.</span><span class=na>trace</span><span class=o>(</span><span class=s>&#34;No @Scheduled annotations found on bean class: &#34;</span> <span class=o>+</span> <span class=n>targetClass</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// Non-empty set of methods
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=n>annotatedMethods</span><span class=o>.</span><span class=na>forEach</span><span class=o>((</span><span class=n>method</span><span class=o>,</span> <span class=n>scheduledAnnotations</span><span class=o>)</span> <span class=o>-&gt;</span>
</span></span><span class=line><span class=cl>						<span class=n>scheduledAnnotations</span><span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=n>scheduled</span> <span class=o>-&gt;</span> <span class=n>processScheduled</span><span class=o>(</span><span class=n>scheduled</span><span class=o>,</span> <span class=n>method</span><span class=o>,</span> <span class=n>bean</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=o>(</span><span class=n>logger</span><span class=o>.</span><span class=na>isTraceEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>logger</span><span class=o>.</span><span class=na>trace</span><span class=o>(</span><span class=n>annotatedMethods</span><span class=o>.</span><span class=na>size</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34; @Scheduled methods processed on bean &#39;&#34;</span> <span class=o>+</span> <span class=n>beanName</span> <span class=o>+</span>
</span></span><span class=line><span class=cl>							<span class=s>&#34;&#39;: &#34;</span> <span class=o>+</span> <span class=n>annotatedMethods</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>bean</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Process the given {@code @Scheduled} method declaration on the given bean.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @param scheduled the {@code @Scheduled} annotation
</span></span></span><span class=line><span class=cl><span class=cm>	 * @param method the method that the annotation has been declared on
</span></span></span><span class=line><span class=cl><span class=cm>	 * @param bean the target bean instance
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see #createRunnable(Object, Method)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>protected</span> <span class=kt>void</span> <span class=nf>processScheduled</span><span class=o>(</span><span class=n>Scheduled</span> <span class=n>scheduled</span><span class=o>,</span> <span class=n>Method</span> <span class=n>method</span><span class=o>,</span> <span class=n>Object</span> <span class=n>bean</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>Runnable</span> <span class=n>runnable</span> <span class=o>=</span> <span class=n>createRunnable</span><span class=o>(</span><span class=n>bean</span><span class=o>,</span> <span class=n>method</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=kt>boolean</span> <span class=n>processedSchedule</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			<span class=n>String</span> <span class=n>errorMessage</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;Exactly one of the &#39;cron&#39;, &#39;fixedDelay(String)&#39;, or &#39;fixedRate(String)&#39; attributes is required&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>Set</span><span class=o>&lt;</span><span class=n>ScheduledTask</span><span class=o>&gt;</span> <span class=n>tasks</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashSet</span><span class=o>&lt;&gt;(</span><span class=mi>4</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// Determine initial delay
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=kt>long</span> <span class=n>initialDelay</span> <span class=o>=</span> <span class=n>convertToMillis</span><span class=o>(</span><span class=n>scheduled</span><span class=o>.</span><span class=na>initialDelay</span><span class=o>(),</span> <span class=n>scheduled</span><span class=o>.</span><span class=na>timeUnit</span><span class=o>());</span>
</span></span><span class=line><span class=cl>			<span class=n>String</span> <span class=n>initialDelayString</span> <span class=o>=</span> <span class=n>scheduled</span><span class=o>.</span><span class=na>initialDelayString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>hasText</span><span class=o>(</span><span class=n>initialDelayString</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>Assert</span><span class=o>.</span><span class=na>isTrue</span><span class=o>(</span><span class=n>initialDelay</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=o>,</span> <span class=s>&#34;Specify &#39;initialDelay&#39; or &#39;initialDelayString&#39;, not both&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>embeddedValueResolver</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>initialDelayString</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>embeddedValueResolver</span><span class=o>.</span><span class=na>resolveStringValue</span><span class=o>(</span><span class=n>initialDelayString</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>hasLength</span><span class=o>(</span><span class=n>initialDelayString</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=n>initialDelay</span> <span class=o>=</span> <span class=n>convertToMillis</span><span class=o>(</span><span class=n>initialDelayString</span><span class=o>,</span> <span class=n>scheduled</span><span class=o>.</span><span class=na>timeUnit</span><span class=o>());</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>					<span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>								<span class=s>&#34;Invalid initialDelayString value \&#34;&#34;</span> <span class=o>+</span> <span class=n>initialDelayString</span> <span class=o>+</span> <span class=s>&#34;\&#34; - cannot parse into long&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// Check cron expression
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=n>String</span> <span class=n>cron</span> <span class=o>=</span> <span class=n>scheduled</span><span class=o>.</span><span class=na>cron</span><span class=o>();</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>hasText</span><span class=o>(</span><span class=n>cron</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>String</span> <span class=n>zone</span> <span class=o>=</span> <span class=n>scheduled</span><span class=o>.</span><span class=na>zone</span><span class=o>();</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>embeddedValueResolver</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>cron</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>embeddedValueResolver</span><span class=o>.</span><span class=na>resolveStringValue</span><span class=o>(</span><span class=n>cron</span><span class=o>);</span>
</span></span><span class=line><span class=cl>					<span class=n>zone</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>embeddedValueResolver</span><span class=o>.</span><span class=na>resolveStringValue</span><span class=o>(</span><span class=n>zone</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>hasLength</span><span class=o>(</span><span class=n>cron</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>Assert</span><span class=o>.</span><span class=na>isTrue</span><span class=o>(</span><span class=n>initialDelay</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=o>,</span> <span class=s>&#34;&#39;initialDelay&#39; not supported for cron triggers&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>					<span class=n>processedSchedule</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=o>(!</span><span class=n>Scheduled</span><span class=o>.</span><span class=na>CRON_DISABLED</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>cron</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=n>TimeZone</span> <span class=n>timeZone</span><span class=o>;</span>
</span></span><span class=line><span class=cl>						<span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>hasText</span><span class=o>(</span><span class=n>zone</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>							<span class=n>timeZone</span> <span class=o>=</span> <span class=n>StringUtils</span><span class=o>.</span><span class=na>parseTimeZoneString</span><span class=o>(</span><span class=n>zone</span><span class=o>);</span>
</span></span><span class=line><span class=cl>						<span class=o>}</span>
</span></span><span class=line><span class=cl>						<span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>							<span class=n>timeZone</span> <span class=o>=</span> <span class=n>TimeZone</span><span class=o>.</span><span class=na>getDefault</span><span class=o>();</span>
</span></span><span class=line><span class=cl>						<span class=o>}</span>
</span></span><span class=line><span class=cl>						<span class=n>tasks</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>scheduleCronTask</span><span class=o>(</span><span class=k>new</span> <span class=n>CronTask</span><span class=o>(</span><span class=n>runnable</span><span class=o>,</span> <span class=k>new</span> <span class=n>CronTrigger</span><span class=o>(</span><span class=n>cron</span><span class=o>,</span> <span class=n>timeZone</span><span class=o>))));</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// At this point we don&#39;t need to differentiate between initial delay set or not anymore
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>if</span> <span class=o>(</span><span class=n>initialDelay</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>initialDelay</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// Check fixed delay
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=kt>long</span> <span class=n>fixedDelay</span> <span class=o>=</span> <span class=n>convertToMillis</span><span class=o>(</span><span class=n>scheduled</span><span class=o>.</span><span class=na>fixedDelay</span><span class=o>(),</span> <span class=n>scheduled</span><span class=o>.</span><span class=na>timeUnit</span><span class=o>());</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>fixedDelay</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>Assert</span><span class=o>.</span><span class=na>isTrue</span><span class=o>(!</span><span class=n>processedSchedule</span><span class=o>,</span> <span class=n>errorMessage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=n>processedSchedule</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>				<span class=n>tasks</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>scheduleFixedDelayTask</span><span class=o>(</span><span class=k>new</span> <span class=n>FixedDelayTask</span><span class=o>(</span><span class=n>runnable</span><span class=o>,</span> <span class=n>fixedDelay</span><span class=o>,</span> <span class=n>initialDelay</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=n>String</span> <span class=n>fixedDelayString</span> <span class=o>=</span> <span class=n>scheduled</span><span class=o>.</span><span class=na>fixedDelayString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>hasText</span><span class=o>(</span><span class=n>fixedDelayString</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>embeddedValueResolver</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>fixedDelayString</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>embeddedValueResolver</span><span class=o>.</span><span class=na>resolveStringValue</span><span class=o>(</span><span class=n>fixedDelayString</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>hasLength</span><span class=o>(</span><span class=n>fixedDelayString</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>Assert</span><span class=o>.</span><span class=na>isTrue</span><span class=o>(!</span><span class=n>processedSchedule</span><span class=o>,</span> <span class=n>errorMessage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>					<span class=n>processedSchedule</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>					<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=n>fixedDelay</span> <span class=o>=</span> <span class=n>convertToMillis</span><span class=o>(</span><span class=n>fixedDelayString</span><span class=o>,</span> <span class=n>scheduled</span><span class=o>.</span><span class=na>timeUnit</span><span class=o>());</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>					<span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>								<span class=s>&#34;Invalid fixedDelayString value \&#34;&#34;</span> <span class=o>+</span> <span class=n>fixedDelayString</span> <span class=o>+</span> <span class=s>&#34;\&#34; - cannot parse into long&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>					<span class=n>tasks</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>scheduleFixedDelayTask</span><span class=o>(</span><span class=k>new</span> <span class=n>FixedDelayTask</span><span class=o>(</span><span class=n>runnable</span><span class=o>,</span> <span class=n>fixedDelay</span><span class=o>,</span> <span class=n>initialDelay</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// Check fixed rate
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=kt>long</span> <span class=n>fixedRate</span> <span class=o>=</span> <span class=n>convertToMillis</span><span class=o>(</span><span class=n>scheduled</span><span class=o>.</span><span class=na>fixedRate</span><span class=o>(),</span> <span class=n>scheduled</span><span class=o>.</span><span class=na>timeUnit</span><span class=o>());</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>fixedRate</span> <span class=o>&gt;=</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>Assert</span><span class=o>.</span><span class=na>isTrue</span><span class=o>(!</span><span class=n>processedSchedule</span><span class=o>,</span> <span class=n>errorMessage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=n>processedSchedule</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>				<span class=n>tasks</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>scheduleFixedRateTask</span><span class=o>(</span><span class=k>new</span> <span class=n>FixedRateTask</span><span class=o>(</span><span class=n>runnable</span><span class=o>,</span> <span class=n>fixedRate</span><span class=o>,</span> <span class=n>initialDelay</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=n>String</span> <span class=n>fixedRateString</span> <span class=o>=</span> <span class=n>scheduled</span><span class=o>.</span><span class=na>fixedRateString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>hasText</span><span class=o>(</span><span class=n>fixedRateString</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>embeddedValueResolver</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>fixedRateString</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>embeddedValueResolver</span><span class=o>.</span><span class=na>resolveStringValue</span><span class=o>(</span><span class=n>fixedRateString</span><span class=o>);</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>hasLength</span><span class=o>(</span><span class=n>fixedRateString</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>Assert</span><span class=o>.</span><span class=na>isTrue</span><span class=o>(!</span><span class=n>processedSchedule</span><span class=o>,</span> <span class=n>errorMessage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>					<span class=n>processedSchedule</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>					<span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=n>fixedRate</span> <span class=o>=</span> <span class=n>convertToMillis</span><span class=o>(</span><span class=n>fixedRateString</span><span class=o>,</span> <span class=n>scheduled</span><span class=o>.</span><span class=na>timeUnit</span><span class=o>());</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>					<span class=k>catch</span> <span class=o>(</span><span class=n>RuntimeException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>						<span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>								<span class=s>&#34;Invalid fixedRateString value \&#34;&#34;</span> <span class=o>+</span> <span class=n>fixedRateString</span> <span class=o>+</span> <span class=s>&#34;\&#34; - cannot parse into long&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>					<span class=o>}</span>
</span></span><span class=line><span class=cl>					<span class=n>tasks</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>scheduleFixedRateTask</span><span class=o>(</span><span class=k>new</span> <span class=n>FixedRateTask</span><span class=o>(</span><span class=n>runnable</span><span class=o>,</span> <span class=n>fixedRate</span><span class=o>,</span> <span class=n>initialDelay</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// Check whether we had any attribute set
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=n>Assert</span><span class=o>.</span><span class=na>isTrue</span><span class=o>(</span><span class=n>processedSchedule</span><span class=o>,</span> <span class=n>errorMessage</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>			<span class=c1>// Finally register the scheduled tasks
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>scheduledTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>Set</span><span class=o>&lt;</span><span class=n>ScheduledTask</span><span class=o>&gt;</span> <span class=n>regTasks</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>scheduledTasks</span><span class=o>.</span><span class=na>computeIfAbsent</span><span class=o>(</span><span class=n>bean</span><span class=o>,</span> <span class=n>key</span> <span class=o>-&gt;</span> <span class=k>new</span> <span class=n>LinkedHashSet</span><span class=o>&lt;&gt;(</span><span class=mi>4</span><span class=o>));</span>
</span></span><span class=line><span class=cl>				<span class=n>regTasks</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>tasks</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>catch</span> <span class=o>(</span><span class=n>IllegalArgumentException</span> <span class=n>ex</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=o>(</span>
</span></span><span class=line><span class=cl>					<span class=s>&#34;Encountered invalid @Scheduled method &#39;&#34;</span> <span class=o>+</span> <span class=n>method</span><span class=o>.</span><span class=na>getName</span><span class=o>()</span> <span class=o>+</span> <span class=s>&#34;&#39;: &#34;</span> <span class=o>+</span> <span class=n>ex</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Create a {@link Runnable} for the given bean instance,
</span></span></span><span class=line><span class=cl><span class=cm>	 * calling the specified scheduled method.
</span></span></span><span class=line><span class=cl><span class=cm>	 * &lt;p&gt;The default implementation creates a {@link ScheduledMethodRunnable}.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @param target the target bean instance
</span></span></span><span class=line><span class=cl><span class=cm>	 * @param method the scheduled method to call
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 5.1
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see ScheduledMethodRunnable#ScheduledMethodRunnable(Object, Method)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>protected</span> <span class=n>Runnable</span> <span class=nf>createRunnable</span><span class=o>(</span><span class=n>Object</span> <span class=n>target</span><span class=o>,</span> <span class=n>Method</span> <span class=n>method</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>Assert</span><span class=o>.</span><span class=na>isTrue</span><span class=o>(</span><span class=n>method</span><span class=o>.</span><span class=na>getParameterCount</span><span class=o>()</span> <span class=o>==</span> <span class=mi>0</span><span class=o>,</span> <span class=s>&#34;Only no-arg methods may be annotated with @Scheduled&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=n>Method</span> <span class=n>invocableMethod</span> <span class=o>=</span> <span class=n>AopUtils</span><span class=o>.</span><span class=na>selectInvocableMethod</span><span class=o>(</span><span class=n>method</span><span class=o>,</span> <span class=n>target</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=k>new</span> <span class=n>ScheduledMethodRunnable</span><span class=o>(</span><span class=n>target</span><span class=o>,</span> <span class=n>invocableMethod</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>static</span> <span class=kt>long</span> <span class=nf>convertToMillis</span><span class=o>(</span><span class=kt>long</span> <span class=n>value</span><span class=o>,</span> <span class=n>TimeUnit</span> <span class=n>timeUnit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>TimeUnit</span><span class=o>.</span><span class=na>MILLISECONDS</span><span class=o>.</span><span class=na>convert</span><span class=o>(</span><span class=n>value</span><span class=o>,</span> <span class=n>timeUnit</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>static</span> <span class=kt>long</span> <span class=nf>convertToMillis</span><span class=o>(</span><span class=n>String</span> <span class=n>value</span><span class=o>,</span> <span class=n>TimeUnit</span> <span class=n>timeUnit</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>isDurationString</span><span class=o>(</span><span class=n>value</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=n>Duration</span><span class=o>.</span><span class=na>parse</span><span class=o>(</span><span class=n>value</span><span class=o>).</span><span class=na>toMillis</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>convertToMillis</span><span class=o>(</span><span class=n>Long</span><span class=o>.</span><span class=na>parseLong</span><span class=o>(</span><span class=n>value</span><span class=o>),</span> <span class=n>timeUnit</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>isDurationString</span><span class=o>(</span><span class=n>String</span> <span class=n>value</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>(</span><span class=n>value</span><span class=o>.</span><span class=na>length</span><span class=o>()</span> <span class=o>&gt;</span> <span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=o>(</span><span class=n>isP</span><span class=o>(</span><span class=n>value</span><span class=o>.</span><span class=na>charAt</span><span class=o>(</span><span class=mi>0</span><span class=o>))</span> <span class=o>||</span> <span class=n>isP</span><span class=o>(</span><span class=n>value</span><span class=o>.</span><span class=na>charAt</span><span class=o>(</span><span class=mi>1</span><span class=o>))));</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>isP</span><span class=o>(</span><span class=kt>char</span> <span class=n>ch</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>(</span><span class=n>ch</span> <span class=o>==</span> <span class=sc>&#39;P&#39;</span> <span class=o>||</span> <span class=n>ch</span> <span class=o>==</span> <span class=sc>&#39;p&#39;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Return all currently scheduled tasks, from {@link Scheduled} methods
</span></span></span><span class=line><span class=cl><span class=cm>	 * as well as from programmatic {@link SchedulingConfigurer} interaction.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 5.0.2
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>ScheduledTask</span><span class=o>&gt;</span> <span class=nf>getScheduledTasks</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>Set</span><span class=o>&lt;</span><span class=n>ScheduledTask</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashSet</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>		<span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>scheduledTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>Collection</span><span class=o>&lt;</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>ScheduledTask</span><span class=o>&gt;&gt;</span> <span class=n>allTasks</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>scheduledTasks</span><span class=o>.</span><span class=na>values</span><span class=o>();</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=o>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>ScheduledTask</span><span class=o>&gt;</span> <span class=n>tasks</span> <span class=o>:</span> <span class=n>allTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>result</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>tasks</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=n>result</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>getScheduledTasks</span><span class=o>());</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>result</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>postProcessBeforeDestruction</span><span class=o>(</span><span class=n>Object</span> <span class=n>bean</span><span class=o>,</span> <span class=n>String</span> <span class=n>beanName</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>Set</span><span class=o>&lt;</span><span class=n>ScheduledTask</span><span class=o>&gt;</span> <span class=n>tasks</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>scheduledTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>tasks</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>scheduledTasks</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>bean</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>tasks</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=o>(</span><span class=n>ScheduledTask</span> <span class=n>task</span> <span class=o>:</span> <span class=n>tasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>task</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>requiresDestruction</span><span class=o>(</span><span class=n>Object</span> <span class=n>bean</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>scheduledTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>scheduledTasks</span><span class=o>.</span><span class=na>containsKey</span><span class=o>(</span><span class=n>bean</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>destroy</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=kd>synchronized</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>scheduledTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>Collection</span><span class=o>&lt;</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>ScheduledTask</span><span class=o>&gt;&gt;</span> <span class=n>allTasks</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>scheduledTasks</span><span class=o>.</span><span class=na>values</span><span class=o>();</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=o>(</span><span class=n>Set</span><span class=o>&lt;</span><span class=n>ScheduledTask</span><span class=o>&gt;</span> <span class=n>tasks</span> <span class=o>:</span> <span class=n>allTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=k>for</span> <span class=o>(</span><span class=n>ScheduledTask</span> <span class=n>task</span> <span class=o>:</span> <span class=n>tasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>					<span class=n>task</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>				<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>scheduledTasks</span><span class=o>.</span><span class=na>clear</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>registrar</span><span class=o>.</span><span class=na>destroy</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><p>第二个关键类</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * Helper bean for registering tasks with a {@link TaskScheduler}, typically using cron
</span></span></span><span class=line><span class=cl><span class=cm> * expressions.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * &lt;p&gt;As of Spring 3.1, {@code ScheduledTaskRegistrar} has a more prominent user-facing
</span></span></span><span class=line><span class=cl><span class=cm> * role when used in conjunction with the {@link
</span></span></span><span class=line><span class=cl><span class=cm> * org.springframework.scheduling.annotation.EnableAsync @EnableAsync} annotation and its
</span></span></span><span class=line><span class=cl><span class=cm> * {@link org.springframework.scheduling.annotation.SchedulingConfigurer
</span></span></span><span class=line><span class=cl><span class=cm> * SchedulingConfigurer} callback interface.
</span></span></span><span class=line><span class=cl><span class=cm> *
</span></span></span><span class=line><span class=cl><span class=cm> * @author Juergen Hoeller
</span></span></span><span class=line><span class=cl><span class=cm> * @author Chris Beams
</span></span></span><span class=line><span class=cl><span class=cm> * @author Tobias Montagna-Hay
</span></span></span><span class=line><span class=cl><span class=cm> * @author Sam Brannen
</span></span></span><span class=line><span class=cl><span class=cm> * @since 3.0
</span></span></span><span class=line><span class=cl><span class=cm> * @see org.springframework.scheduling.annotation.EnableAsync
</span></span></span><span class=line><span class=cl><span class=cm> * @see org.springframework.scheduling.annotation.SchedulingConfigurer
</span></span></span><span class=line><span class=cl><span class=cm> */</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ScheduledTaskRegistrar</span> <span class=kd>implements</span> <span class=n>ScheduledTaskHolder</span><span class=o>,</span> <span class=n>InitializingBean</span><span class=o>,</span> <span class=n>DisposableBean</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * A special cron expression value that indicates a disabled trigger: {@value}.
</span></span></span><span class=line><span class=cl><span class=cm>	 * &lt;p&gt;This is primarily meant for use with {@link #addCronTask(Runnable, String)}
</span></span></span><span class=line><span class=cl><span class=cm>	 * when the value for the supplied {@code expression} is retrieved from an
</span></span></span><span class=line><span class=cl><span class=cm>	 * external source &amp;mdash; for example, from a property in the
</span></span></span><span class=line><span class=cl><span class=cm>	 * {@link org.springframework.core.env.Environment Environment}.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 5.2
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see org.springframework.scheduling.annotation.Scheduled#CRON_DISABLED
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>CRON_DISABLED</span> <span class=o>=</span> <span class=s>&#34;-&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=n>TaskScheduler</span> <span class=n>taskScheduler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=n>ScheduledExecutorService</span> <span class=n>localExecutor</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>TriggerTask</span><span class=o>&gt;</span> <span class=n>triggerTasks</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>CronTask</span><span class=o>&gt;</span> <span class=n>cronTasks</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>IntervalTask</span><span class=o>&gt;</span> <span class=n>fixedRateTasks</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>IntervalTask</span><span class=o>&gt;</span> <span class=n>fixedDelayTasks</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Task</span><span class=o>,</span> <span class=n>ScheduledTask</span><span class=o>&gt;</span> <span class=n>unresolvedTasks</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;(</span><span class=mi>16</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kd>final</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>ScheduledTask</span><span class=o>&gt;</span> <span class=n>scheduledTasks</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashSet</span><span class=o>&lt;&gt;(</span><span class=mi>16</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Set the {@link TaskScheduler} to register scheduled tasks with.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setTaskScheduler</span><span class=o>(</span><span class=n>TaskScheduler</span> <span class=n>taskScheduler</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>Assert</span><span class=o>.</span><span class=na>notNull</span><span class=o>(</span><span class=n>taskScheduler</span><span class=o>,</span> <span class=s>&#34;TaskScheduler must not be null&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span> <span class=o>=</span> <span class=n>taskScheduler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Set the {@link TaskScheduler} to register scheduled tasks with, or a
</span></span></span><span class=line><span class=cl><span class=cm>	 * {@link java.util.concurrent.ScheduledExecutorService} to be wrapped as a
</span></span></span><span class=line><span class=cl><span class=cm>	 * {@code TaskScheduler}.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setScheduler</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>Object</span> <span class=n>scheduler</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>scheduler</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>scheduler</span> <span class=k>instanceof</span> <span class=n>TaskScheduler</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span> <span class=o>=</span> <span class=o>(</span><span class=n>TaskScheduler</span><span class=o>)</span> <span class=n>scheduler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=n>scheduler</span> <span class=k>instanceof</span> <span class=n>ScheduledExecutorService</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentTaskScheduler</span><span class=o>(((</span><span class=n>ScheduledExecutorService</span><span class=o>)</span> <span class=n>scheduler</span><span class=o>));</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=o>(</span><span class=s>&#34;Unsupported scheduler type: &#34;</span> <span class=o>+</span> <span class=n>scheduler</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Return the {@link TaskScheduler} instance for this registrar (may be {@code null}).
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>TaskScheduler</span> <span class=nf>getScheduler</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Specify triggered tasks as a Map of Runnables (the tasks) and Trigger objects
</span></span></span><span class=line><span class=cl><span class=cm>	 * (typically custom implementations of the {@link Trigger} interface).
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setTriggerTasks</span><span class=o>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>,</span> <span class=n>Trigger</span><span class=o>&gt;</span> <span class=n>triggerTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>triggerTasks</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>		<span class=n>triggerTasks</span><span class=o>.</span><span class=na>forEach</span><span class=o>((</span><span class=n>task</span><span class=o>,</span> <span class=n>trigger</span><span class=o>)</span> <span class=o>-&gt;</span> <span class=n>addTriggerTask</span><span class=o>(</span><span class=k>new</span> <span class=n>TriggerTask</span><span class=o>(</span><span class=n>task</span><span class=o>,</span> <span class=n>trigger</span><span class=o>)));</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Specify triggered tasks as a list of {@link TriggerTask} objects. Primarily used
</span></span></span><span class=line><span class=cl><span class=cm>	 * by {@code &lt;task:*&gt;} namespace parsing.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 3.2
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see ScheduledTasksBeanDefinitionParser
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setTriggerTasksList</span><span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>TriggerTask</span><span class=o>&gt;</span> <span class=n>triggerTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>triggerTasks</span> <span class=o>=</span> <span class=n>triggerTasks</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Get the trigger tasks as an unmodifiable list of {@link TriggerTask} objects.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @return the list of tasks (never {@code null})
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 4.2
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>TriggerTask</span><span class=o>&gt;</span> <span class=nf>getTriggerTaskList</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>triggerTasks</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>?</span> <span class=n>Collections</span><span class=o>.</span><span class=na>unmodifiableList</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>triggerTasks</span><span class=o>)</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=n>Collections</span><span class=o>.</span><span class=na>emptyList</span><span class=o>());</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Specify triggered tasks as a Map of Runnables (the tasks) and cron expressions.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see CronTrigger
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setCronTasks</span><span class=o>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>cronTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>cronTasks</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>		<span class=n>cronTasks</span><span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=k>this</span><span class=o>::</span><span class=n>addCronTask</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Specify triggered tasks as a list of {@link CronTask} objects. Primarily used by
</span></span></span><span class=line><span class=cl><span class=cm>	 * {@code &lt;task:*&gt;} namespace parsing.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 3.2
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see ScheduledTasksBeanDefinitionParser
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setCronTasksList</span><span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>CronTask</span><span class=o>&gt;</span> <span class=n>cronTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>cronTasks</span> <span class=o>=</span> <span class=n>cronTasks</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Get the cron tasks as an unmodifiable list of {@link CronTask} objects.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @return the list of tasks (never {@code null})
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 4.2
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>CronTask</span><span class=o>&gt;</span> <span class=nf>getCronTaskList</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>cronTasks</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>Collections</span><span class=o>.</span><span class=na>unmodifiableList</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>cronTasks</span><span class=o>)</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=n>Collections</span><span class=o>.</span><span class=na>emptyList</span><span class=o>());</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Specify triggered tasks as a Map of Runnables (the tasks) and fixed-rate values.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see TaskScheduler#scheduleAtFixedRate(Runnable, long)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setFixedRateTasks</span><span class=o>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>,</span> <span class=n>Long</span><span class=o>&gt;</span> <span class=n>fixedRateTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>fixedRateTasks</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>		<span class=n>fixedRateTasks</span><span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=k>this</span><span class=o>::</span><span class=n>addFixedRateTask</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Specify fixed-rate tasks as a list of {@link IntervalTask} objects. Primarily used
</span></span></span><span class=line><span class=cl><span class=cm>	 * by {@code &lt;task:*&gt;} namespace parsing.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 3.2
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see ScheduledTasksBeanDefinitionParser
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setFixedRateTasksList</span><span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>IntervalTask</span><span class=o>&gt;</span> <span class=n>fixedRateTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>fixedRateTasks</span> <span class=o>=</span> <span class=n>fixedRateTasks</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Get the fixed-rate tasks as an unmodifiable list of {@link IntervalTask} objects.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @return the list of tasks (never {@code null})
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 4.2
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>IntervalTask</span><span class=o>&gt;</span> <span class=nf>getFixedRateTaskList</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>fixedRateTasks</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>Collections</span><span class=o>.</span><span class=na>unmodifiableList</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>fixedRateTasks</span><span class=o>)</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=n>Collections</span><span class=o>.</span><span class=na>emptyList</span><span class=o>());</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Specify triggered tasks as a Map of Runnables (the tasks) and fixed-delay values.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see TaskScheduler#scheduleWithFixedDelay(Runnable, long)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setFixedDelayTasks</span><span class=o>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>,</span> <span class=n>Long</span><span class=o>&gt;</span> <span class=n>fixedDelayTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>fixedDelayTasks</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>		<span class=n>fixedDelayTasks</span><span class=o>.</span><span class=na>forEach</span><span class=o>(</span><span class=k>this</span><span class=o>::</span><span class=n>addFixedDelayTask</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Specify fixed-delay tasks as a list of {@link IntervalTask} objects. Primarily used
</span></span></span><span class=line><span class=cl><span class=cm>	 * by {@code &lt;task:*&gt;} namespace parsing.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 3.2
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see ScheduledTasksBeanDefinitionParser
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>setFixedDelayTasksList</span><span class=o>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>IntervalTask</span><span class=o>&gt;</span> <span class=n>fixedDelayTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>fixedDelayTasks</span> <span class=o>=</span> <span class=n>fixedDelayTasks</span><span class=o>;</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Get the fixed-delay tasks as an unmodifiable list of {@link IntervalTask} objects.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @return the list of tasks (never {@code null})
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 4.2
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>IntervalTask</span><span class=o>&gt;</span> <span class=nf>getFixedDelayTaskList</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>fixedDelayTasks</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>Collections</span><span class=o>.</span><span class=na>unmodifiableList</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>fixedDelayTasks</span><span class=o>)</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=n>Collections</span><span class=o>.</span><span class=na>emptyList</span><span class=o>());</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Add a Runnable task to be triggered per the given {@link Trigger}.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see TaskScheduler#scheduleAtFixedRate(Runnable, long)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>addTriggerTask</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>task</span><span class=o>,</span> <span class=n>Trigger</span> <span class=n>trigger</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>addTriggerTask</span><span class=o>(</span><span class=k>new</span> <span class=n>TriggerTask</span><span class=o>(</span><span class=n>task</span><span class=o>,</span> <span class=n>trigger</span><span class=o>));</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Add a {@code TriggerTask}.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 3.2
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see TaskScheduler#scheduleAtFixedRate(Runnable, long)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>addTriggerTask</span><span class=o>(</span><span class=n>TriggerTask</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>triggerTasks</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>triggerTasks</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>triggerTasks</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Add a {@link Runnable} task to be triggered per the given cron {@code expression}.
</span></span></span><span class=line><span class=cl><span class=cm>	 * &lt;p&gt;As of Spring Framework 5.2, this method will not register the task if the
</span></span></span><span class=line><span class=cl><span class=cm>	 * {@code expression} is equal to {@link #CRON_DISABLED}.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>addCronTask</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>task</span><span class=o>,</span> <span class=n>String</span> <span class=n>expression</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(!</span><span class=n>CRON_DISABLED</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>expression</span><span class=o>))</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>addCronTask</span><span class=o>(</span><span class=k>new</span> <span class=n>CronTask</span><span class=o>(</span><span class=n>task</span><span class=o>,</span> <span class=n>expression</span><span class=o>));</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Add a {@link CronTask}.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 3.2
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>addCronTask</span><span class=o>(</span><span class=n>CronTask</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>cronTasks</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>cronTasks</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>cronTasks</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Add a {@code Runnable} task to be triggered at the given fixed-rate interval.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see TaskScheduler#scheduleAtFixedRate(Runnable, long)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>addFixedRateTask</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>task</span><span class=o>,</span> <span class=kt>long</span> <span class=n>interval</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>addFixedRateTask</span><span class=o>(</span><span class=k>new</span> <span class=n>IntervalTask</span><span class=o>(</span><span class=n>task</span><span class=o>,</span> <span class=n>interval</span><span class=o>,</span> <span class=mi>0</span><span class=o>));</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Add a fixed-rate {@link IntervalTask}.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 3.2
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see TaskScheduler#scheduleAtFixedRate(Runnable, long)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>addFixedRateTask</span><span class=o>(</span><span class=n>IntervalTask</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>fixedRateTasks</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>fixedRateTasks</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>fixedRateTasks</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Add a Runnable task to be triggered with the given fixed delay.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see TaskScheduler#scheduleWithFixedDelay(Runnable, long)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>addFixedDelayTask</span><span class=o>(</span><span class=n>Runnable</span> <span class=n>task</span><span class=o>,</span> <span class=kt>long</span> <span class=n>delay</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>addFixedDelayTask</span><span class=o>(</span><span class=k>new</span> <span class=n>IntervalTask</span><span class=o>(</span><span class=n>task</span><span class=o>,</span> <span class=n>delay</span><span class=o>,</span> <span class=mi>0</span><span class=o>));</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Add a fixed-delay {@link IntervalTask}.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 3.2
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see TaskScheduler#scheduleWithFixedDelay(Runnable, long)
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>addFixedDelayTask</span><span class=o>(</span><span class=n>IntervalTask</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>fixedDelayTasks</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>fixedDelayTasks</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>this</span><span class=o>.</span><span class=na>fixedDelayTasks</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Return whether this {@code ScheduledTaskRegistrar} has any tasks registered.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 3.2
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>hasTasks</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>(!</span><span class=n>CollectionUtils</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>triggerTasks</span><span class=o>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>				<span class=o>!</span><span class=n>CollectionUtils</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>cronTasks</span><span class=o>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>				<span class=o>!</span><span class=n>CollectionUtils</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>fixedRateTasks</span><span class=o>)</span> <span class=o>||</span>
</span></span><span class=line><span class=cl>				<span class=o>!</span><span class=n>CollectionUtils</span><span class=o>.</span><span class=na>isEmpty</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>fixedDelayTasks</span><span class=o>));</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Calls {@link #scheduleTasks()} at bean construction time.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>afterPropertiesSet</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>scheduleTasks</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Schedule all registered tasks against the underlying
</span></span></span><span class=line><span class=cl><span class=cm>	 * {@linkplain #setTaskScheduler(TaskScheduler) task scheduler}.
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@SuppressWarnings</span><span class=o>(</span><span class=s>&#34;deprecation&#34;</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=kd>protected</span> <span class=kt>void</span> <span class=nf>scheduleTasks</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>localExecutor</span> <span class=o>=</span> <span class=n>Executors</span><span class=o>.</span><span class=na>newSingleThreadScheduledExecutor</span><span class=o>();</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConcurrentTaskScheduler</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>localExecutor</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>triggerTasks</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=o>(</span><span class=n>TriggerTask</span> <span class=n>task</span> <span class=o>:</span> <span class=k>this</span><span class=o>.</span><span class=na>triggerTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>addScheduledTask</span><span class=o>(</span><span class=n>scheduleTriggerTask</span><span class=o>(</span><span class=n>task</span><span class=o>));</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>cronTasks</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=o>(</span><span class=n>CronTask</span> <span class=n>task</span> <span class=o>:</span> <span class=k>this</span><span class=o>.</span><span class=na>cronTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>addScheduledTask</span><span class=o>(</span><span class=n>scheduleCronTask</span><span class=o>(</span><span class=n>task</span><span class=o>));</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>fixedRateTasks</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=o>(</span><span class=n>IntervalTask</span> <span class=n>task</span> <span class=o>:</span> <span class=k>this</span><span class=o>.</span><span class=na>fixedRateTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>addScheduledTask</span><span class=o>(</span><span class=n>scheduleFixedRateTask</span><span class=o>(</span><span class=n>task</span><span class=o>));</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>fixedDelayTasks</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=o>(</span><span class=n>IntervalTask</span> <span class=n>task</span> <span class=o>:</span> <span class=k>this</span><span class=o>.</span><span class=na>fixedDelayTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>addScheduledTask</span><span class=o>(</span><span class=n>scheduleFixedDelayTask</span><span class=o>(</span><span class=n>task</span><span class=o>));</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=kd>private</span> <span class=kt>void</span> <span class=nf>addScheduledTask</span><span class=o>(</span><span class=nd>@Nullable</span> <span class=n>ScheduledTask</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>task</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>scheduledTasks</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Schedule the specified trigger task, either right away if possible
</span></span></span><span class=line><span class=cl><span class=cm>	 * or on initialization of the scheduler.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @return a handle to the scheduled task, allowing to cancel it
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 4.3
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>ScheduledTask</span> <span class=nf>scheduleTriggerTask</span><span class=o>(</span><span class=n>TriggerTask</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>ScheduledTask</span> <span class=n>scheduledTask</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>unresolvedTasks</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=kt>boolean</span> <span class=n>newTask</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>scheduledTask</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>scheduledTask</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ScheduledTask</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>newTask</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>scheduledTask</span><span class=o>.</span><span class=na>future</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span><span class=o>.</span><span class=na>schedule</span><span class=o>(</span><span class=n>task</span><span class=o>.</span><span class=na>getRunnable</span><span class=o>(),</span> <span class=n>task</span><span class=o>.</span><span class=na>getTrigger</span><span class=o>());</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>addTriggerTask</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>unresolvedTasks</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>task</span><span class=o>,</span> <span class=n>scheduledTask</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>(</span><span class=n>newTask</span> <span class=o>?</span> <span class=n>scheduledTask</span> <span class=o>:</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Schedule the specified cron task, either right away if possible
</span></span></span><span class=line><span class=cl><span class=cm>	 * or on initialization of the scheduler.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @return a handle to the scheduled task, allowing to cancel it
</span></span></span><span class=line><span class=cl><span class=cm>	 * (or {@code null} if processing a previously registered task)
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 4.3
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>ScheduledTask</span> <span class=nf>scheduleCronTask</span><span class=o>(</span><span class=n>CronTask</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>ScheduledTask</span> <span class=n>scheduledTask</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>unresolvedTasks</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=kt>boolean</span> <span class=n>newTask</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>scheduledTask</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>scheduledTask</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ScheduledTask</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>newTask</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>scheduledTask</span><span class=o>.</span><span class=na>future</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span><span class=o>.</span><span class=na>schedule</span><span class=o>(</span><span class=n>task</span><span class=o>.</span><span class=na>getRunnable</span><span class=o>(),</span> <span class=n>task</span><span class=o>.</span><span class=na>getTrigger</span><span class=o>());</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>addCronTask</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>unresolvedTasks</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>task</span><span class=o>,</span> <span class=n>scheduledTask</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>(</span><span class=n>newTask</span> <span class=o>?</span> <span class=n>scheduledTask</span> <span class=o>:</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Schedule the specified fixed-rate task, either right away if possible
</span></span></span><span class=line><span class=cl><span class=cm>	 * or on initialization of the scheduler.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @return a handle to the scheduled task, allowing to cancel it
</span></span></span><span class=line><span class=cl><span class=cm>	 * (or {@code null} if processing a previously registered task)
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 4.3
</span></span></span><span class=line><span class=cl><span class=cm>	 * @deprecated as of 5.0.2, in favor of {@link #scheduleFixedRateTask(FixedRateTask)}
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Deprecated</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>ScheduledTask</span> <span class=nf>scheduleFixedRateTask</span><span class=o>(</span><span class=n>IntervalTask</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>FixedRateTask</span> <span class=n>taskToUse</span> <span class=o>=</span> <span class=o>(</span><span class=n>task</span> <span class=k>instanceof</span> <span class=n>FixedRateTask</span> <span class=o>?</span> <span class=o>(</span><span class=n>FixedRateTask</span><span class=o>)</span> <span class=n>task</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=k>new</span> <span class=n>FixedRateTask</span><span class=o>(</span><span class=n>task</span><span class=o>.</span><span class=na>getRunnable</span><span class=o>(),</span> <span class=n>task</span><span class=o>.</span><span class=na>getInterval</span><span class=o>(),</span> <span class=n>task</span><span class=o>.</span><span class=na>getInitialDelay</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>scheduleFixedRateTask</span><span class=o>(</span><span class=n>taskToUse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Schedule the specified fixed-rate task, either right away if possible
</span></span></span><span class=line><span class=cl><span class=cm>	 * or on initialization of the scheduler.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @return a handle to the scheduled task, allowing to cancel it
</span></span></span><span class=line><span class=cl><span class=cm>	 * (or {@code null} if processing a previously registered task)
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 5.0.2
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>ScheduledTask</span> <span class=nf>scheduleFixedRateTask</span><span class=o>(</span><span class=n>FixedRateTask</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>ScheduledTask</span> <span class=n>scheduledTask</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>unresolvedTasks</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=kt>boolean</span> <span class=n>newTask</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>scheduledTask</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>scheduledTask</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ScheduledTask</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>newTask</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>task</span><span class=o>.</span><span class=na>getInitialDelay</span><span class=o>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>Date</span> <span class=n>startTime</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Date</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span><span class=o>.</span><span class=na>getClock</span><span class=o>().</span><span class=na>millis</span><span class=o>()</span> <span class=o>+</span> <span class=n>task</span><span class=o>.</span><span class=na>getInitialDelay</span><span class=o>());</span>
</span></span><span class=line><span class=cl>				<span class=n>scheduledTask</span><span class=o>.</span><span class=na>future</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>						<span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span><span class=o>.</span><span class=na>scheduleAtFixedRate</span><span class=o>(</span><span class=n>task</span><span class=o>.</span><span class=na>getRunnable</span><span class=o>(),</span> <span class=n>startTime</span><span class=o>,</span> <span class=n>task</span><span class=o>.</span><span class=na>getInterval</span><span class=o>());</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>scheduledTask</span><span class=o>.</span><span class=na>future</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>						<span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span><span class=o>.</span><span class=na>scheduleAtFixedRate</span><span class=o>(</span><span class=n>task</span><span class=o>.</span><span class=na>getRunnable</span><span class=o>(),</span> <span class=n>task</span><span class=o>.</span><span class=na>getInterval</span><span class=o>());</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>addFixedRateTask</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>unresolvedTasks</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>task</span><span class=o>,</span> <span class=n>scheduledTask</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>(</span><span class=n>newTask</span> <span class=o>?</span> <span class=n>scheduledTask</span> <span class=o>:</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Schedule the specified fixed-delay task, either right away if possible
</span></span></span><span class=line><span class=cl><span class=cm>	 * or on initialization of the scheduler.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @return a handle to the scheduled task, allowing to cancel it
</span></span></span><span class=line><span class=cl><span class=cm>	 * (or {@code null} if processing a previously registered task)
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 4.3
</span></span></span><span class=line><span class=cl><span class=cm>	 * @deprecated as of 5.0.2, in favor of {@link #scheduleFixedDelayTask(FixedDelayTask)}
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Deprecated</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>ScheduledTask</span> <span class=nf>scheduleFixedDelayTask</span><span class=o>(</span><span class=n>IntervalTask</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>FixedDelayTask</span> <span class=n>taskToUse</span> <span class=o>=</span> <span class=o>(</span><span class=n>task</span> <span class=k>instanceof</span> <span class=n>FixedDelayTask</span> <span class=o>?</span> <span class=o>(</span><span class=n>FixedDelayTask</span><span class=o>)</span> <span class=n>task</span> <span class=o>:</span>
</span></span><span class=line><span class=cl>				<span class=k>new</span> <span class=n>FixedDelayTask</span><span class=o>(</span><span class=n>task</span><span class=o>.</span><span class=na>getRunnable</span><span class=o>(),</span> <span class=n>task</span><span class=o>.</span><span class=na>getInterval</span><span class=o>(),</span> <span class=n>task</span><span class=o>.</span><span class=na>getInitialDelay</span><span class=o>()));</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>scheduleFixedDelayTask</span><span class=o>(</span><span class=n>taskToUse</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Schedule the specified fixed-delay task, either right away if possible
</span></span></span><span class=line><span class=cl><span class=cm>	 * or on initialization of the scheduler.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @return a handle to the scheduled task, allowing to cancel it
</span></span></span><span class=line><span class=cl><span class=cm>	 * (or {@code null} if processing a previously registered task)
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 5.0.2
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Nullable</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>ScheduledTask</span> <span class=nf>scheduleFixedDelayTask</span><span class=o>(</span><span class=n>FixedDelayTask</span> <span class=n>task</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=n>ScheduledTask</span> <span class=n>scheduledTask</span> <span class=o>=</span> <span class=k>this</span><span class=o>.</span><span class=na>unresolvedTasks</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=kt>boolean</span> <span class=n>newTask</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=n>scheduledTask</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>scheduledTask</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ScheduledTask</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=n>newTask</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=o>(</span><span class=n>task</span><span class=o>.</span><span class=na>getInitialDelay</span><span class=o>()</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>Date</span> <span class=n>startTime</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Date</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span><span class=o>.</span><span class=na>getClock</span><span class=o>().</span><span class=na>millis</span><span class=o>()</span> <span class=o>+</span> <span class=n>task</span><span class=o>.</span><span class=na>getInitialDelay</span><span class=o>());</span>
</span></span><span class=line><span class=cl>				<span class=n>scheduledTask</span><span class=o>.</span><span class=na>future</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>						<span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span><span class=o>.</span><span class=na>scheduleWithFixedDelay</span><span class=o>(</span><span class=n>task</span><span class=o>.</span><span class=na>getRunnable</span><span class=o>(),</span> <span class=n>startTime</span><span class=o>,</span> <span class=n>task</span><span class=o>.</span><span class=na>getInterval</span><span class=o>());</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>			<span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>				<span class=n>scheduledTask</span><span class=o>.</span><span class=na>future</span> <span class=o>=</span>
</span></span><span class=line><span class=cl>						<span class=k>this</span><span class=o>.</span><span class=na>taskScheduler</span><span class=o>.</span><span class=na>scheduleWithFixedDelay</span><span class=o>(</span><span class=n>task</span><span class=o>.</span><span class=na>getRunnable</span><span class=o>(),</span> <span class=n>task</span><span class=o>.</span><span class=na>getInterval</span><span class=o>());</span>
</span></span><span class=line><span class=cl>			<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>addFixedDelayTask</span><span class=o>(</span><span class=n>task</span><span class=o>);</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>unresolvedTasks</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>task</span><span class=o>,</span> <span class=n>scheduledTask</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=o>(</span><span class=n>newTask</span> <span class=o>?</span> <span class=n>scheduledTask</span> <span class=o>:</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>	 * Return all locally registered tasks that have been scheduled by this registrar.
</span></span></span><span class=line><span class=cl><span class=cm>	 * @since 5.0.2
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see #addTriggerTask
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see #addCronTask
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see #addFixedRateTask
</span></span></span><span class=line><span class=cl><span class=cm>	 * @see #addFixedDelayTask
</span></span></span><span class=line><span class=cl><span class=cm>	 */</span>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>ScheduledTask</span><span class=o>&gt;</span> <span class=nf>getScheduledTasks</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=n>Collections</span><span class=o>.</span><span class=na>unmodifiableSet</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>scheduledTasks</span><span class=o>);</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nd>@Override</span>
</span></span><span class=line><span class=cl>	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>destroy</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>		<span class=k>for</span> <span class=o>(</span><span class=n>ScheduledTask</span> <span class=n>task</span> <span class=o>:</span> <span class=k>this</span><span class=o>.</span><span class=na>scheduledTasks</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=n>task</span><span class=o>.</span><span class=na>cancel</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>localExecutor</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>			<span class=k>this</span><span class=o>.</span><span class=na>localExecutor</span><span class=o>.</span><span class=na>shutdownNow</span><span class=o>();</span>
</span></span><span class=line><span class=cl>		<span class=o>}</span>
</span></span><span class=line><span class=cl>	<span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></div><h1 id=拓展应用>拓展应用<a hidden class=anchor aria-hidden=true href=#拓展应用>#</a></h1></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://www.catguild.cn/posts/markdown%E8%AF%AD%E6%B3%95%E6%B5%8B%E8%AF%95/><span class=title>« Prev</span><br><span>markdown语法效果测试</span></a>
<a class=next href=https://www.catguild.cn/posts/springboot%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%B9%E6%B3%95/><span class=title>Next »</span><br><span>SpringBoot初始化方法</span></a></nav></footer></article></main><footer class=footer><span>Copyright
&copy;
2023-2023
<a href=https://www.catguild.cn/ style=color:#939393>猫公会</a>
All Rights Reserved</span><div class="footer-line thanks"><span class="icp footer-divider">特别感谢
<a href=https://gohugo.io target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.111.3">Hugo</a> |
<a href=https://github.com/adityatelange/hugo-PaperMod target=_blank rel=external title="PaperMod 7.0">PaperMod</a> |
<a href=https://github.com target=_blank rel="noopener noreffer">GitHub</a> |
<a href=https://vercel.com target=_blank rel="noopener noreffer">Vercel</a></span></div><div class="footer-line beian"><a href=https://beian.miit.gov.cn/ target=_blank style=color:#939393>皖ICP备 20012821 号</a>&nbsp;
<span><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=34082602201751" style=display:inline-block;text-decoration:none;height:20px;color:#939393><img src=/img/beian.png style="float:left;margin:0 5px 0 0">
皖公网安备 34082602201751 号</a></span></div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>