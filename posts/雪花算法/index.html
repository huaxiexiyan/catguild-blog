<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>é›ªèŠ±ç®—æ³• | çŒ«å…¬ä¼š</title><meta name=keywords content><meta name=description content="snowflake åˆ†å¸ƒå¼idç”Ÿæˆç®—æ³•çš„æœ‰å¾ˆå¤šç§ï¼ŒTwitterçš„é›ªèŠ±ç®—æ³•ï¼ˆSnowFlakeï¼‰å°±æ˜¯å…¶ä¸­ç»å…¸çš„ä¸€ç§ã€‚ SnowFlakeç®—æ³•çš„ä¼˜ç‚¹ï¼š ç”ŸæˆIDæ—¶ä¸ä¾èµ–äºæ•°æ®åº“ï¼Œå®Œå…¨åœ¨å†…å­˜ç”Ÿæˆï¼Œé«˜æ€§èƒ½é«˜å¯ç”¨ã€‚ å®¹é‡å¤§ï¼Œæ¯ç§’å¯ç”Ÿæˆå‡ ç™¾ä¸‡IDã€‚ SnowFlakeç®—æ³•åœ¨åŒ"><meta name=author content="
ä½œè€…:&nbsp;Me"><link rel=canonical href=https://www.catguild.cn/posts/%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95/><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.9c7c35e2f76542323b21747a40f1590c09c8cb45d08e4d7c82e632663381bae6.css integrity="sha256-nHw14vdlQjI7IXR6QPFZDAnIy0XQjk18guYyZjOBuuY=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://www.catguild.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://www.catguild.cn/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://www.catguild.cn/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://www.catguild.cn/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://www.catguild.cn/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script async src="https://www.googletagmanager.com/gtag/js?id=G-49K5GYEZX0"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-49K5GYEZX0")</script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?6e15f273a2871fda1150e7f434efa838",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="é›ªèŠ±ç®—æ³•"><meta property="og:description" content="snowflake åˆ†å¸ƒå¼idç”Ÿæˆç®—æ³•çš„æœ‰å¾ˆå¤šç§ï¼ŒTwitterçš„é›ªèŠ±ç®—æ³•ï¼ˆSnowFlakeï¼‰å°±æ˜¯å…¶ä¸­ç»å…¸çš„ä¸€ç§ã€‚ SnowFlakeç®—æ³•çš„ä¼˜ç‚¹ï¼š ç”ŸæˆIDæ—¶ä¸ä¾èµ–äºæ•°æ®åº“ï¼Œå®Œå…¨åœ¨å†…å­˜ç”Ÿæˆï¼Œé«˜æ€§èƒ½é«˜å¯ç”¨ã€‚ å®¹é‡å¤§ï¼Œæ¯ç§’å¯ç”Ÿæˆå‡ ç™¾ä¸‡IDã€‚ SnowFlakeç®—æ³•åœ¨åŒ"><meta property="og:type" content="article"><meta property="og:url" content="https://www.catguild.cn/posts/%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95/"><meta property="og:image" content="https://www.catguild.cn/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="og:site_name" content="ExampleSite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://www.catguild.cn/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="é›ªèŠ±ç®—æ³•"><meta name=twitter:description content="snowflake åˆ†å¸ƒå¼idç”Ÿæˆç®—æ³•çš„æœ‰å¾ˆå¤šç§ï¼ŒTwitterçš„é›ªèŠ±ç®—æ³•ï¼ˆSnowFlakeï¼‰å°±æ˜¯å…¶ä¸­ç»å…¸çš„ä¸€ç§ã€‚ SnowFlakeç®—æ³•çš„ä¼˜ç‚¹ï¼š ç”ŸæˆIDæ—¶ä¸ä¾èµ–äºæ•°æ®åº“ï¼Œå®Œå…¨åœ¨å†…å­˜ç”Ÿæˆï¼Œé«˜æ€§èƒ½é«˜å¯ç”¨ã€‚ å®¹é‡å¤§ï¼Œæ¯ç§’å¯ç”Ÿæˆå‡ ç™¾ä¸‡IDã€‚ SnowFlakeç®—æ³•åœ¨åŒ"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://www.catguild.cn/posts/"},{"@type":"ListItem","position":2,"name":"é›ªèŠ±ç®—æ³•","item":"https://www.catguild.cn/posts/%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"é›ªèŠ±ç®—æ³•","name":"é›ªèŠ±ç®—æ³•","description":"snowflake åˆ†å¸ƒå¼idç”Ÿæˆç®—æ³•çš„æœ‰å¾ˆå¤šç§ï¼ŒTwitterçš„é›ªèŠ±ç®—æ³•ï¼ˆSnowFlakeï¼‰å°±æ˜¯å…¶ä¸­ç»å…¸çš„ä¸€ç§ã€‚ SnowFlakeç®—æ³•çš„ä¼˜ç‚¹ï¼š ç”ŸæˆIDæ—¶ä¸ä¾èµ–äºæ•°æ®åº“ï¼Œå®Œå…¨åœ¨å†…å­˜ç”Ÿæˆï¼Œé«˜æ€§èƒ½é«˜å¯ç”¨ã€‚ å®¹é‡å¤§ï¼Œæ¯ç§’å¯ç”Ÿæˆå‡ ç™¾ä¸‡IDã€‚ SnowFlakeç®—æ³•åœ¨åŒ","keywords":[],"articleBody":"snowflake åˆ†å¸ƒå¼idç”Ÿæˆç®—æ³•çš„æœ‰å¾ˆå¤šç§ï¼ŒTwitterçš„é›ªèŠ±ç®—æ³•ï¼ˆSnowFlakeï¼‰å°±æ˜¯å…¶ä¸­ç»å…¸çš„ä¸€ç§ã€‚\nSnowFlakeç®—æ³•çš„ä¼˜ç‚¹ï¼š\nç”ŸæˆIDæ—¶ä¸ä¾èµ–äºæ•°æ®åº“ï¼Œå®Œå…¨åœ¨å†…å­˜ç”Ÿæˆï¼Œé«˜æ€§èƒ½é«˜å¯ç”¨ã€‚ å®¹é‡å¤§ï¼Œæ¯ç§’å¯ç”Ÿæˆå‡ ç™¾ä¸‡IDã€‚ SnowFlakeç®—æ³•åœ¨åŒä¸€æ¯«ç§’å†…æœ€å¤šå¯ä»¥ç”Ÿæˆå¤šå°‘ä¸ªå…¨å±€å”¯ä¸€IDå‘¢ï¼ŸåŒä¸€æ¯«ç§’çš„IDæ•°é‡ = 1024 * 4096 = 4194304 æ‰€æœ‰ç”Ÿæˆçš„idæŒ‰æ—¶é—´è¶‹åŠ¿é€’å¢ï¼Œåç»­æ’å…¥æ•°æ®åº“çš„ç´¢å¼•æ ‘çš„æ—¶å€™ï¼Œæ€§èƒ½è¾ƒé«˜ã€‚ æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå†…ä¸ä¼šäº§ç”Ÿé‡å¤idï¼ˆå› ä¸ºæœ‰datacenterIdå’ŒworkerIdæ¥åšåŒºåˆ†ï¼‰ SnowFlakeç®—æ³•çš„ç¼ºç‚¹ï¼š\nä¾èµ–äºç³»ç»Ÿæ—¶é’Ÿçš„ä¸€è‡´æ€§ã€‚å¦‚æœæŸå°æœºå™¨çš„ç³»ç»Ÿæ—¶é’Ÿå›æ‹¨ï¼Œæœ‰å¯èƒ½é€ æˆIDå†²çªï¼Œæˆ–è€…IDä¹±åºã€‚ è¿˜æœ‰ï¼Œåœ¨å¯åŠ¨ä¹‹å‰ï¼Œå¦‚æœè¿™å°æœºå™¨çš„ç³»ç»Ÿæ—¶é—´å›æ‹¨è¿‡ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½å‡ºç°IDé‡å¤çš„å±é™©ã€‚ é—®é¢˜ï¼Ÿ\nworkId æ€ä¹ˆä¿è¯å”¯ä¸€ï¼Ÿ\nå¯ä»¥é€šè¿‡åˆ†å¸ƒå¼ç¼“å­˜æ¥ä¿å­˜æœºå™¨IDå’ŒworkIdä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚å¯åŠ¨çš„æ—¶å€™è®¿é—®åˆ†å¸ƒå¼ç¼“å­˜æŸ¥è¯¢å½“å‰æœºå™¨IDå¯¹åº”çš„workIdï¼Œå¦‚æœæŸ¥è¯¢ä¸åˆ°åˆ™è·å–ä¸€ä¸ªå¹¶ä¿å­˜åˆ°åˆ†å¸ƒå¼ç¼“å­˜ä¸­ã€‚ å¯é€šè¿‡Zookeeperç®¡ç†workIdï¼Œå…å»æ‰‹åŠ¨é¢‘ç¹ä¿®æ”¹é›†ç¾¤èŠ‚ç‚¹ï¼Œå»é…ç½®æœºå™¨IDçš„éº»çƒ¦ã€‚ lastTimestampä¸Šæ¬¡ç”ŸæˆIDçš„æ—¶é—´æˆ³ï¼Œè¿™ä¸ªæ˜¯åœ¨å†…å­˜ä¸­ï¼Œç³»ç»Ÿæ—¶é’Ÿå›é€€+é‡å¯åå‘¢ï¼Ÿæ— æ³•ä¿è¯\nç›®å‰å¥½åƒåªèƒ½æµç¨‹ä¸Šæ§åˆ¶ç³»ç»Ÿæ—¶é’Ÿä¸å›é€€ã€‚ 41ä½\n(timestamp - this.twepoch) \u003c\u003c this.timestampLeftShift è¶…è¿‡é•¿æ•´å‹æ€ä¹ˆåŠï¼Ÿ\nthis.twepoch å¯ä»¥è®¾ç½®å½“å‰å¼€å§‹ä½¿ç”¨ç³»ç»Ÿæ—¶çš„æ—¶é—´ï¼Œå¯ä»¥ä¿è¯69å¹´ä¸è¶… Javascript æ— æ³•æ”¯æŒ\u003e 53ä½çš„æ•°å­—æ€ä¹ˆåŠï¼Ÿ\njs Numberè¢«è¡¨ç¤ºä¸ºåŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œæœ€å¤§å€¼ä¸º Number.MAX_SAFE_INTEGER = 2^53-1 BigInt æ˜¯ JavaScript ä¸­çš„ä¸€ä¸ªæ–°çš„åŸå§‹æ•°å­—ç±»å‹ï¼Œå¯ä»¥ç”¨ä»»æ„ç²¾åº¦è¡¨ç¤ºæ•´æ•°ã€‚å³ä½¿è¶…å‡º Number çš„å®‰å…¨æ•´æ•°èŒƒå›´é™åˆ¶ï¼Œä¹Ÿå¯ä»¥å®‰å…¨åœ°å­˜å‚¨å’Œæ“ä½œå¤§æ•´æ•°ã€‚ è¦åˆ›å»ºä¸€ä¸ª BigIntï¼Œå°† n ä½œä¸ºåç¼€æ·»åŠ åˆ°ä»»ä½•æ•´æ•°æ–‡å­—å­—é¢é‡ BigInt æ”¯æŒå¤§æ•°ï¼Œé‚£æ€ä¹ˆæ§åˆ¶è¿™é‡Œç”¨ 64bits é•¿æ•´å‹ï¼Œå·¦ç§»æº¢å‡ºä¼šå‡ºç°é—®é¢˜å—ï¼Ÿ\nè¿™é‡Œä¸åšå¤„ç†ä¼šå‡ºç°é—®é¢˜ï¼ŒBigInt å¯ä»¥ç”¨ä»»æ„ç²¾åº¦è¡¨ç¤ºæ•´æ•°\nå¦‚ä½•å¤„ç†ï¼Ÿ\næš‚ä¸å¤„ç†\næ­¤é—®é¢˜æœ¬è´¨è¿˜æ˜¯ä¸Šé¢çš„41ä½æ—¶é—´å·®é—®é¢˜ï¼Œ69å¹´ä¸è¶…ï¼Œå†é•¿å°±è¶…äº†ï¼Œéœ€è¦é‡æ–°è®¾è®¡æ”¯æŒï¼Œä¹Ÿå¯ä»¥åšæº¢å‡ºæç¤ºã€‚ å¦‚æœæƒ³é™åˆ¶ä¸ºä»…64ä½æ•´æ•°ï¼Œåˆ™å¿…é¡»å§‹ç»ˆä½¿ç”¨å¼ºåˆ¶è½¬æ¢ BigInt.asIntN BigInt.asUintN åªè¦æˆ‘ä»¬ä¼ é€’ BigInt è¶…è¿‡ 64 ä½æ•´æ•°èŒƒå›´çš„å€¼ï¼ˆä¾‹å¦‚ï¼Œ63 ä½æ•°å€¼ + 1 ä½ç¬¦å·ä½ï¼‰ï¼Œå°±ä¼šå‘ç”Ÿæº¢å‡ºã€‚ æ¦‚è¿° SnowFlakeç®—æ³•ç”Ÿæˆidçš„ç»“æœæ˜¯ä¸€ä¸ª64bitå¤§å°çš„æ•´æ•°ï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹å›¾ï¼š\n1ä½ï¼Œä¸ç”¨ã€‚äºŒè¿›åˆ¶ä¸­æœ€é«˜ä½ä¸º1çš„éƒ½æ˜¯è´Ÿæ•°ï¼Œä½†æ˜¯æˆ‘ä»¬ç”Ÿæˆçš„idä¸€èˆ¬éƒ½ä½¿ç”¨æ•´æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªæœ€é«˜ä½å›ºå®šæ˜¯0\n41ä½ ï¼Œç”¨æ¥è®°å½•æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ã€‚\n41ä½å¯ä»¥è¡¨ç¤º$2^{41}-1$ä¸ªæ•°å­—ï¼Œ å¦‚æœåªç”¨æ¥è¡¨ç¤ºæ­£æ•´æ•°ï¼ˆè®¡ç®—æœºä¸­æ­£æ•°åŒ…å«0ï¼‰ï¼Œå¯ä»¥è¡¨ç¤ºçš„æ•°å€¼èŒƒå›´æ˜¯ï¼š0 è‡³ $2^{41}-1$ï¼Œå‡1æ˜¯å› ä¸ºå¯è¡¨ç¤ºçš„æ•°å€¼èŒƒå›´æ˜¯ä»0å¼€å§‹ç®—çš„ï¼Œè€Œä¸æ˜¯1ã€‚ ä¹Ÿå°±æ˜¯è¯´41ä½å¯ä»¥è¡¨ç¤º$2^{41}-1$ä¸ªæ¯«ç§’çš„å€¼ï¼Œè½¬åŒ–æˆå•ä½å¹´åˆ™æ˜¯$(2^{41}-1) / (1000 * 60 * 60 * 24 * 365) = 69$å¹´ 10ä½ ï¼Œç”¨æ¥è®°å½•å·¥ä½œæœºå™¨idã€‚\nå¯ä»¥éƒ¨ç½²åœ¨$2^{10} = 1024$ä¸ªèŠ‚ç‚¹ï¼ŒåŒ…æ‹¬5ä½datacenterIdå’Œ5ä½workerId 5ä½ï¼ˆbitï¼‰å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§æ­£æ•´æ•°æ˜¯$2^{5}-1 = 31$ï¼Œå³å¯ä»¥ç”¨0ã€1ã€2ã€3ã€â€¦.31è¿™32ä¸ªæ•°å­—ï¼Œæ¥è¡¨ç¤ºä¸åŒçš„datecenterIdæˆ–workerId 12ä½ ï¼Œåºåˆ—å·ï¼Œç”¨æ¥è®°å½•åŒæ¯«ç§’å†…äº§ç”Ÿçš„ä¸åŒidã€‚\n12ä½ï¼ˆbitï¼‰å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§æ­£æ•´æ•°æ˜¯$2^{12}-1 = 4095$ï¼Œå³å¯ä»¥ç”¨0ã€1ã€2ã€3ã€â€¦.4094è¿™4095ä¸ªæ•°å­—ï¼Œæ¥è¡¨ç¤ºåŒä¸€æœºå™¨åŒä¸€æ—¶é—´æˆªï¼ˆæ¯«ç§’)å†…äº§ç”Ÿçš„4095ä¸ªIDåºå· ç”±äº64bitçš„æ•´æ•°æ˜¯longç±»å‹ï¼Œæ‰€ä»¥SnowFlakeç®—æ³•ç”Ÿæˆçš„idå°±æ˜¯longæ¥å­˜å‚¨çš„ã€‚ä½†è¿™ä¸ªé•¿åº¦è¶…å‡º js æœ€å¤§æ•°èŒƒå›´ Number.MAX_SAFE_INTEGER äº†ï¼Œåœ¨js ä¸­å®ç°è¦ä½¿ç”¨ BigInt æ¥è¡¨ç¤ºã€‚\nTalk is cheap, show you the code JS ç‰ˆæœ¬\nä»£ç ç†è§£ https://segmentfault.com/a/1190000011282426\nä½è¿ç®—åŸºç¡€ åœ¨è®¡ç®—æœºä¸­ï¼Œè´Ÿæ•°çš„äºŒè¿›åˆ¶æ˜¯ç”¨è¡¥ç æ¥è¡¨ç¤ºçš„ã€‚ åç  = é™¤ç¬¦å·ä½, åŸç å…¶ä½™ä½å–åè€Œå¾— è¡¥ç  = åç  + 1 è¡¥ç  = ï¼ˆåŸç  - 1ï¼‰å†å–åç  åœ¨è®¡ç®—æœºä¸­æ— ç¬¦å·æ•°ç”¨åŸç è¡¨ç¤º, æœ‰ç¬¦å·æ•°ç”¨è¡¥ç è¡¨ç¤º è¡¥ç çš„æ„ä¹‰å°±æ˜¯å¯ä»¥æ‹¿è¡¥ç å’ŒåŸç ï¼ˆ3çš„äºŒè¿›åˆ¶ï¼‰ç›¸åŠ ï¼Œæœ€ç»ˆåŠ å‡ºä¸€ä¸ªâ€œæº¢å‡ºçš„0â€\nå› æ­¤-1çš„äºŒè¿›åˆ¶åº”è¯¥è¿™æ ·ç®—ï¼š\n00000000 00000000 00000000 00000001 //åŸç ï¼š1çš„äºŒè¿›åˆ¶ 11111111 11111111 11111111 11111110 //å–åç ï¼š1çš„äºŒè¿›åˆ¶çš„åç  11111111 11111111 11111111 11111111 //åŠ 1ï¼š-1çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼ˆè¡¥ç ï¼‰ ç”¨ä½è¿ç®—è®¡ç®—nä¸ªbitèƒ½è¡¨ç¤ºçš„æœ€å¤§æ•°å€¼ const maxWorkerId = -1n ^ (-1n \u003c\u003c 5n) // åˆ©ç”¨ä½è¿ç®—è®¡ç®—å‡º5ä½èƒ½è¡¨ç¤ºçš„æœ€å¤§æ­£æ•´æ•°æ˜¯å¤šå°‘ -1 å·¦ç§» 5ï¼Œå¾—ç»“æœa ï¼š\n11111111 11111111 11111111 11111111 // -1çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼ˆè¡¥ç ï¼‰ 11111 11111111 11111111 11111111 11100000 // é«˜ä½æº¢å‡ºçš„ä¸è¦ï¼Œä½ä½è¡¥0 11111111 11111111 11111111 11100000 // ç»“æœa -1 å¼‚æˆ– a ï¼š\n11111111 11111111 11111111 11111111 // -1çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼ˆè¡¥ç ï¼‰ ^ 11111111 11111111 11111111 11100000 // ä¸¤ä¸ªæ“ä½œæ•°çš„ä½ä¸­ï¼Œç›¸åŒåˆ™ä¸º0ï¼Œä¸åŒåˆ™ä¸º1 --------------------------------------------------------------------------- 00000000 00000000 00000000 00011111 // æœ€ç»ˆç»“æœ31 æœ€ç»ˆç»“æœæ˜¯31ï¼ŒäºŒè¿›åˆ¶ 00000000 00000000 00000000 00011111 è½¬åè¿›åˆ¶å¯ä»¥è¿™ä¹ˆç®—ï¼š\n24+23+22+21+20=16+8+4+2+1=31\nç”¨maské˜²æ­¢æº¢å‡º this.sequence = (this.sequence + 1n) \u0026 this.sequenceMask; // è¿™æ®µä»£ç é€šè¿‡ `ä½ä¸` è¿ç®—ä¿è¯è®¡ç®—çš„ç»“æœèŒƒå›´å§‹ç»ˆæ˜¯ 0-4095 ç”¨ä½è¿ç®—æ±‡æ€»ç»“æœ ä½æˆ–è¿ç®—ï¼ŒåŒä¸€ä½åªè¦æœ‰ä¸€ä¸ªæ˜¯1ï¼Œåˆ™ç»“æœä¸º1ï¼Œå¦åˆ™ä¸º0ã€‚\nä½è¿ç®—å·¦ç§»è¶…å‡ºçš„æº¢å‡ºéƒ¨åˆ†æ‰”æ‰ï¼Œå³ä¾§ç©ºä½åˆ™è¡¥0ã€‚\nreturn ( ((timestamp - this.twepoch) \u003c\u003c this.timestampLeftShift) | // æ—¶é—´å·®å·¦ç§»22 (this.dataCenterId \u003c\u003c this.dataCenterIdShift) | // æ•°æ®æ ‡è¯†idå·¦ç§» 17 (this.workerId \u003c\u003c this.workerIdShift) | // æœºå™¨idå·¦ç§» 12 this.sequence ); -------------------- | |ç®€åŒ– \\|/ -------------------- return (la) | (lb) | (lc) | sequence; æ•°æ®ç¤ºä¾‹ï¼š timestamp: 1505914988849 twepoch: 1288834974657 datacenterId: 17 workerId: 25 sequence: 0 äºŒè¿›åˆ¶è¿‡ç¨‹ 1 | 41 | 5 | 5 | 12 0|0001100 10100010 10111110 10001001 01011100 00| | | //la 0| |10001| | //lb 0| | |1 1001| //lc or 0| | | |â€­0000 00000000â€¬ //sequence ------------------------------------------------------------------------------------------ 0|0001100 10100010 10111110 10001001 01011100 00|10001|1 1001|â€­0000 00000000â€¬ //ç»“æœï¼š910499571847892992 æ”¯æŒåæ¨æ•°æ® åæ¨æœºå™¨IDã€æ•°æ®ä¸­å¿ƒIDå’Œåˆ›å»ºçš„æ—¶é—´æˆ³\næœºå™¨ID = id Â» workerIdShift \u0026 ~(-1n Â« workerIdBits); æ•°æ®ä¸­å¿ƒID = id Â» datacenterIdShift \u0026 ~(-1n Â« datacenterIdBits); æ—¶é—´æˆ³ = id Â» timestampLeftShift \u0026 ~(-1n Â« 41n) + twepoch; å‚è€ƒï¼š\né›ªèŠ±ç®—æ³•\nTwitterå®˜æ–¹åŸç‰ˆ ç”¨Scalaå†™çš„ Twitter IDï¼ˆSnowflakeï¼‰ IDç”Ÿæˆå™¨ï¼ŒTwitterçš„é›ªèŠ±ç®—æ³•ï¼ˆJavaï¼‰ ç†è§£åˆ†å¸ƒå¼idç”Ÿæˆç®—æ³•SnowFlake BigInt\nBigIntï¼šJavaScript ä¸­çš„ä»»æ„ç²¾åº¦æ•´æ•° BigInt: arbitrary-precision integers in JavaScript chrome jsbi ES proposal: BigInt â€“ arbitrary precision integers MDN BigInt è¯­æ³• tc39: proposal-bigint Javascript ææ¡ˆ BigInt çš„ä¸€äº›å‘ å…³äºé™åˆ¶ä¸ºä»…64ä½æ•´æ•°ï¼Œéœ€è¦ç‰¹å®šå¤„ç†ï¼Œå¯ä»¥æç¤ºæ•°æ®é•¿åº¦æº¢å‡ºäº†ã€‚\n// åœ¨ console ä¸­æµ‹è¯•ï¼Œæº¢å‡ºæ€ä¹ˆåŠï¼Œæ€ä¹ˆæ£€æŸ¥å‡ºé—®é¢˜äº† var aa = 1n; (aa\u003c\u003c62n).toString(2).padStart(64, 0); (aa\u003c\u003c65n).toString(2).padStart(64, 0); (BigInt.asIntN(64, aa\u003c\u003c62n)).toString(2).padStart(64, 0); (BigInt.asIntN(64, aa\u003c\u003c65n)).toString(2).padStart(64, 0); const max = 2n ** (64n - 1n) - 1n; BigInt.asIntN(64, max); // æœ‰ç¬¦å·æ•° BigInt.asUintN(64, max); // æ— ç¬¦å·æ•° â†’ 9223372036854775807n BigInt.asIntN(64, max + 1n); new BigInt64Array(4) ","wordCount":"2483","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://www.catguild.cn/posts/%E9%9B%AA%E8%8A%B1%E7%AE%97%E6%B3%95/"},"publisher":{"@type":"Organization","name":"çŒ«å…¬ä¼š","logo":{"@type":"ImageObject","url":"https://www.catguild.cn/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://www.catguild.cn/ accesskey=h title="Home (Alt + H)">Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://www.catguild.cn/archives/ title=â±æ—¶é—´è½´><span>â±æ—¶é—´è½´</span></a></li><li><a href=https://www.catguild.cn/categories/ title=åˆ†ç±»><span>åˆ†ç±»</span></a></li><li><a href=https://www.catguild.cn/tags/ title=ğŸ”–æ ‡ç­¾><span>ğŸ”–æ ‡ç­¾</span></a></li><li><a href=https://www.catguild.cn/search/ title="ğŸ”æœç´¢ (Alt + /)" accesskey=/><span>ğŸ”æœç´¢</span></a></li><li><a href=https://www.catguild.cn/links/ title=ğŸ¤å‹é“¾><span>ğŸ¤å‹é“¾</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://www.catguild.cn/>Home</a>&nbsp;Â»&nbsp;<a href=https://www.catguild.cn/posts/>Posts</a></div><h1 class=post-title>é›ªèŠ±ç®—æ³•</h1><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>0001-01-01
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>2483å­—
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>5åˆ†é’Ÿ
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span></span></span></span><span style=opacity:.8><span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span>
<span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>
&nbsp;&nbsp;</span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•å¯¼èˆª</span></summary><div class=inner><ul><li><a href=#snowflake aria-label=snowflake>snowflake</a><ul><li><a href=#%e6%a6%82%e8%bf%b0 aria-label=æ¦‚è¿°>æ¦‚è¿°</a></li><li><a href=#talk-is-cheap-show-you-the-code aria-label="Talk is cheap, show you the code">Talk is cheap, show you the code</a></li><li><a href=#%e4%bb%a3%e7%a0%81%e7%90%86%e8%a7%a3 aria-label=ä»£ç ç†è§£>ä»£ç ç†è§£</a><ul><li><a href=#%e4%bd%8d%e8%bf%90%e7%ae%97%e5%9f%ba%e7%a1%80 aria-label=ä½è¿ç®—åŸºç¡€>ä½è¿ç®—åŸºç¡€</a></li><li><a href=#%e7%94%a8%e4%bd%8d%e8%bf%90%e7%ae%97%e8%ae%a1%e7%ae%97n%e4%b8%aabit%e8%83%bd%e8%a1%a8%e7%a4%ba%e7%9a%84%e6%9c%80%e5%a4%a7%e6%95%b0%e5%80%bc aria-label=ç”¨ä½è¿ç®—è®¡ç®—nä¸ªbitèƒ½è¡¨ç¤ºçš„æœ€å¤§æ•°å€¼>ç”¨ä½è¿ç®—è®¡ç®—nä¸ªbitèƒ½è¡¨ç¤ºçš„æœ€å¤§æ•°å€¼</a></li><li><a href=#%e7%94%a8mask%e9%98%b2%e6%ad%a2%e6%ba%a2%e5%87%ba aria-label=ç”¨maské˜²æ­¢æº¢å‡º>ç”¨maské˜²æ­¢æº¢å‡º</a></li><li><a href=#%e7%94%a8%e4%bd%8d%e8%bf%90%e7%ae%97%e6%b1%87%e6%80%bb%e7%bb%93%e6%9e%9c aria-label=ç”¨ä½è¿ç®—æ±‡æ€»ç»“æœ>ç”¨ä½è¿ç®—æ±‡æ€»ç»“æœ</a></li></ul></li><li><a href=#%e6%94%af%e6%8c%81%e5%8f%8d%e6%8e%a8%e6%95%b0%e6%8d%ae aria-label=æ”¯æŒåæ¨æ•°æ®>æ”¯æŒåæ¨æ•°æ®</a></li></ul></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")})},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><h1 id=snowflake>snowflake<a hidden class=anchor aria-hidden=true href=#snowflake>#</a></h1><p>åˆ†å¸ƒå¼idç”Ÿæˆç®—æ³•çš„æœ‰å¾ˆå¤šç§ï¼ŒTwitterçš„é›ªèŠ±ç®—æ³•ï¼ˆSnowFlakeï¼‰å°±æ˜¯å…¶ä¸­ç»å…¸çš„ä¸€ç§ã€‚</p><p>SnowFlakeç®—æ³•çš„ä¼˜ç‚¹ï¼š</p><ul><li>ç”ŸæˆIDæ—¶ä¸ä¾èµ–äºæ•°æ®åº“ï¼Œå®Œå…¨åœ¨å†…å­˜ç”Ÿæˆï¼Œé«˜æ€§èƒ½é«˜å¯ç”¨ã€‚</li><li>å®¹é‡å¤§ï¼Œæ¯ç§’å¯ç”Ÿæˆå‡ ç™¾ä¸‡IDã€‚<ul><li>SnowFlakeç®—æ³•åœ¨åŒä¸€æ¯«ç§’å†…æœ€å¤šå¯ä»¥ç”Ÿæˆå¤šå°‘ä¸ªå…¨å±€å”¯ä¸€IDå‘¢ï¼ŸåŒä¸€æ¯«ç§’çš„IDæ•°é‡ = 1024 * 4096 = 4194304</li></ul></li><li>æ‰€æœ‰ç”Ÿæˆçš„idæŒ‰æ—¶é—´è¶‹åŠ¿é€’å¢ï¼Œåç»­æ’å…¥æ•°æ®åº“çš„ç´¢å¼•æ ‘çš„æ—¶å€™ï¼Œæ€§èƒ½è¾ƒé«˜ã€‚</li><li>æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå†…ä¸ä¼šäº§ç”Ÿé‡å¤idï¼ˆå› ä¸ºæœ‰<code>datacenterId</code>å’Œ<code>workerId</code>æ¥åšåŒºåˆ†ï¼‰</li></ul><p>SnowFlakeç®—æ³•çš„ç¼ºç‚¹ï¼š</p><ul><li>ä¾èµ–äºç³»ç»Ÿæ—¶é’Ÿçš„ä¸€è‡´æ€§ã€‚å¦‚æœæŸå°æœºå™¨çš„ç³»ç»Ÿæ—¶é’Ÿå›æ‹¨ï¼Œæœ‰å¯èƒ½é€ æˆIDå†²çªï¼Œæˆ–è€…IDä¹±åºã€‚</li><li>è¿˜æœ‰ï¼Œåœ¨å¯åŠ¨ä¹‹å‰ï¼Œå¦‚æœè¿™å°æœºå™¨çš„ç³»ç»Ÿæ—¶é—´å›æ‹¨è¿‡ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½å‡ºç°IDé‡å¤çš„å±é™©ã€‚</li></ul><p>é—®é¢˜ï¼Ÿ</p><ul><li><p>workId æ€ä¹ˆä¿è¯å”¯ä¸€ï¼Ÿ</p><ul><li>å¯ä»¥é€šè¿‡åˆ†å¸ƒå¼ç¼“å­˜æ¥ä¿å­˜æœºå™¨IDå’ŒworkIdä¹‹é—´çš„æ˜ å°„å…³ç³»ã€‚å¯åŠ¨çš„æ—¶å€™è®¿é—®åˆ†å¸ƒå¼ç¼“å­˜æŸ¥è¯¢å½“å‰æœºå™¨IDå¯¹åº”çš„workIdï¼Œå¦‚æœæŸ¥è¯¢ä¸åˆ°åˆ™è·å–ä¸€ä¸ªå¹¶ä¿å­˜åˆ°åˆ†å¸ƒå¼ç¼“å­˜ä¸­ã€‚</li><li>å¯é€šè¿‡Zookeeperç®¡ç†workIdï¼Œå…å»æ‰‹åŠ¨é¢‘ç¹ä¿®æ”¹é›†ç¾¤èŠ‚ç‚¹ï¼Œå»é…ç½®æœºå™¨IDçš„éº»çƒ¦ã€‚</li></ul></li><li><p>lastTimestampä¸Šæ¬¡ç”ŸæˆIDçš„æ—¶é—´æˆ³ï¼Œè¿™ä¸ªæ˜¯åœ¨å†…å­˜ä¸­ï¼Œç³»ç»Ÿæ—¶é’Ÿå›é€€+é‡å¯åå‘¢ï¼Ÿæ— æ³•ä¿è¯</p><ul><li>ç›®å‰å¥½åƒåªèƒ½æµç¨‹ä¸Šæ§åˆ¶ç³»ç»Ÿæ—¶é’Ÿä¸å›é€€ã€‚</li></ul></li><li><p>41ä½</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>(timestamp - this.twepoch) &lt;&lt; this.timestampLeftShift
</span></span></code></pre></div><p>è¶…è¿‡é•¿æ•´å‹æ€ä¹ˆåŠï¼Ÿ</p><ul><li>this.twepoch å¯ä»¥è®¾ç½®å½“å‰å¼€å§‹ä½¿ç”¨ç³»ç»Ÿæ—¶çš„æ—¶é—´ï¼Œå¯ä»¥ä¿è¯69å¹´ä¸è¶…</li></ul></li><li><p>Javascript æ— æ³•æ”¯æŒ> 53ä½çš„æ•°å­—æ€ä¹ˆåŠï¼Ÿ</p><ul><li>js <code>Number</code>è¢«è¡¨ç¤ºä¸ºåŒç²¾åº¦æµ®ç‚¹æ•°ï¼Œæœ€å¤§å€¼ä¸º <code>Number.MAX_SAFE_INTEGER</code> = <code>2^53-1</code></li><li><code>BigInt</code> æ˜¯ JavaScript ä¸­çš„ä¸€ä¸ªæ–°çš„åŸå§‹æ•°å­—ç±»å‹ï¼Œå¯ä»¥ç”¨ä»»æ„ç²¾åº¦è¡¨ç¤ºæ•´æ•°ã€‚å³ä½¿è¶…å‡º <code>Number</code> çš„å®‰å…¨æ•´æ•°èŒƒå›´é™åˆ¶ï¼Œä¹Ÿå¯ä»¥å®‰å…¨åœ°å­˜å‚¨å’Œæ“ä½œå¤§æ•´æ•°ã€‚</li><li>è¦åˆ›å»ºä¸€ä¸ª <code>BigInt</code>ï¼Œå°† <code>n</code> ä½œä¸ºåç¼€æ·»åŠ åˆ°ä»»ä½•æ•´æ•°æ–‡å­—å­—é¢é‡</li></ul></li><li><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>BigInt
</span></span></code></pre></div><p>æ”¯æŒå¤§æ•°ï¼Œé‚£æ€ä¹ˆæ§åˆ¶è¿™é‡Œç”¨ 64bits é•¿æ•´å‹ï¼Œå·¦ç§»æº¢å‡ºä¼šå‡ºç°é—®é¢˜å—ï¼Ÿ</p><ul><li><p>è¿™é‡Œä¸åšå¤„ç†ä¼šå‡ºç°é—®é¢˜ï¼Œ<code>BigInt</code> å¯ä»¥ç”¨ä»»æ„ç²¾åº¦è¡¨ç¤ºæ•´æ•°</p></li><li><p>å¦‚ä½•å¤„ç†ï¼Ÿ</p><p>æš‚ä¸å¤„ç†</p><ul><li>æ­¤é—®é¢˜æœ¬è´¨è¿˜æ˜¯ä¸Šé¢çš„41ä½æ—¶é—´å·®é—®é¢˜ï¼Œ<strong>69å¹´ä¸è¶…ï¼Œå†é•¿å°±è¶…äº†</strong>ï¼Œéœ€è¦é‡æ–°è®¾è®¡æ”¯æŒï¼Œä¹Ÿå¯ä»¥åšæº¢å‡ºæç¤ºã€‚</li><li>å¦‚æœæƒ³é™åˆ¶ä¸ºä»…64ä½æ•´æ•°ï¼Œåˆ™å¿…é¡»å§‹ç»ˆä½¿ç”¨å¼ºåˆ¶è½¬æ¢ <code>BigInt.asIntN</code> <code>BigInt.asUintN</code></li><li>åªè¦æˆ‘ä»¬ä¼ é€’ <code>BigInt</code> è¶…è¿‡ 64 ä½æ•´æ•°èŒƒå›´çš„å€¼ï¼ˆä¾‹å¦‚ï¼Œ63 ä½æ•°å€¼ + 1 ä½ç¬¦å·ä½ï¼‰ï¼Œå°±ä¼šå‘ç”Ÿæº¢å‡ºã€‚</li></ul></li></ul></li></ul><h2 id=æ¦‚è¿°>æ¦‚è¿°<a hidden class=anchor aria-hidden=true href=#æ¦‚è¿°>#</a></h2><p>SnowFlakeç®—æ³•ç”Ÿæˆidçš„ç»“æœæ˜¯ä¸€ä¸ª64bitå¤§å°çš„æ•´æ•°ï¼Œå®ƒçš„ç»“æ„å¦‚ä¸‹å›¾ï¼š</p><p><a href=https://github.com/cloudyan/snowflake/blob/master/docs/1.jpeg><img loading=lazy src=https://github.com/cloudyan/snowflake/raw/master/docs/1.jpeg alt=SnowFlake></a></p><ul><li><p><code>1ä½</code>ï¼Œä¸ç”¨ã€‚äºŒè¿›åˆ¶ä¸­æœ€é«˜ä½ä¸º1çš„éƒ½æ˜¯è´Ÿæ•°ï¼Œä½†æ˜¯æˆ‘ä»¬ç”Ÿæˆçš„idä¸€èˆ¬éƒ½ä½¿ç”¨æ•´æ•°ï¼Œæ‰€ä»¥è¿™ä¸ªæœ€é«˜ä½å›ºå®šæ˜¯0</p></li><li><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>41ä½
</span></span></code></pre></div><p>ï¼Œç”¨æ¥è®°å½•æ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰ã€‚</p><ul><li><code>41ä½</code>å¯ä»¥è¡¨ç¤º<code>$2^{41}-1$</code>ä¸ªæ•°å­—ï¼Œ</li><li>å¦‚æœåªç”¨æ¥è¡¨ç¤ºæ­£æ•´æ•°ï¼ˆè®¡ç®—æœºä¸­æ­£æ•°åŒ…å«0ï¼‰ï¼Œå¯ä»¥è¡¨ç¤ºçš„æ•°å€¼èŒƒå›´æ˜¯ï¼š0 è‡³ <code>$2^{41}-1$</code>ï¼Œå‡1æ˜¯å› ä¸ºå¯è¡¨ç¤ºçš„æ•°å€¼èŒƒå›´æ˜¯ä»0å¼€å§‹ç®—çš„ï¼Œè€Œä¸æ˜¯1ã€‚</li><li>ä¹Ÿå°±æ˜¯è¯´41ä½å¯ä»¥è¡¨ç¤º<code>$2^{41}-1$</code>ä¸ªæ¯«ç§’çš„å€¼ï¼Œè½¬åŒ–æˆå•ä½å¹´åˆ™æ˜¯<code>$(2^{41}-1) / (1000 * 60 * 60 * 24 * 365) = 69$</code>å¹´</li></ul></li><li><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>10ä½
</span></span></code></pre></div><p>ï¼Œç”¨æ¥è®°å½•å·¥ä½œæœºå™¨idã€‚</p><ul><li>å¯ä»¥éƒ¨ç½²åœ¨<code>$2^{10} = 1024$</code>ä¸ªèŠ‚ç‚¹ï¼ŒåŒ…æ‹¬<code>5ä½datacenterId</code>å’Œ<code>5ä½workerId</code></li><li><code>5ä½ï¼ˆbitï¼‰</code>å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§æ­£æ•´æ•°æ˜¯<code>$2^{5}-1 = 31$</code>ï¼Œå³å¯ä»¥ç”¨0ã€1ã€2ã€3ã€&mldr;.31è¿™32ä¸ªæ•°å­—ï¼Œæ¥è¡¨ç¤ºä¸åŒçš„<code>datecenterId</code>æˆ–<code>workerId</code></li></ul></li><li><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>12ä½
</span></span></code></pre></div><p>ï¼Œåºåˆ—å·ï¼Œç”¨æ¥è®°å½•åŒæ¯«ç§’å†…äº§ç”Ÿçš„ä¸åŒidã€‚</p><ul><li><code>12ä½ï¼ˆbitï¼‰</code>å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§æ­£æ•´æ•°æ˜¯<code>$2^{12}-1 = 4095$</code>ï¼Œå³å¯ä»¥ç”¨0ã€1ã€2ã€3ã€&mldr;.4094è¿™4095ä¸ªæ•°å­—ï¼Œæ¥è¡¨ç¤ºåŒä¸€æœºå™¨åŒä¸€æ—¶é—´æˆªï¼ˆæ¯«ç§’)å†…äº§ç”Ÿçš„4095ä¸ªIDåºå·</li></ul></li></ul><p>ç”±äº64bitçš„æ•´æ•°æ˜¯longç±»å‹ï¼Œæ‰€ä»¥SnowFlakeç®—æ³•ç”Ÿæˆçš„idå°±æ˜¯longæ¥å­˜å‚¨çš„ã€‚ä½†è¿™ä¸ªé•¿åº¦è¶…å‡º js æœ€å¤§æ•°èŒƒå›´ <code>Number.MAX_SAFE_INTEGER</code> äº†ï¼Œåœ¨js ä¸­å®ç°è¦ä½¿ç”¨ BigInt æ¥è¡¨ç¤ºã€‚</p><h2 id=talk-is-cheap-show-you-the-code>Talk is cheap, show you the code<a hidden class=anchor aria-hidden=true href=#talk-is-cheap-show-you-the-code>#</a></h2><p><a href=https://github.com/cloudyan/snowflake/blob/master/src/snowflake.js>JS ç‰ˆæœ¬</a></p><h2 id=ä»£ç ç†è§£>ä»£ç ç†è§£<a hidden class=anchor aria-hidden=true href=#ä»£ç ç†è§£>#</a></h2><p><a href=https://segmentfault.com/a/1190000011282426>https://segmentfault.com/a/1190000011282426</a></p><h3 id=ä½è¿ç®—åŸºç¡€>ä½è¿ç®—åŸºç¡€<a hidden class=anchor aria-hidden=true href=#ä½è¿ç®—åŸºç¡€>#</a></h3><ul><li>åœ¨è®¡ç®—æœºä¸­ï¼Œè´Ÿæ•°çš„äºŒè¿›åˆ¶æ˜¯ç”¨è¡¥ç æ¥è¡¨ç¤ºçš„ã€‚<ul><li>åç  = é™¤ç¬¦å·ä½, åŸç å…¶ä½™ä½å–åè€Œå¾—</li><li>è¡¥ç  = åç  + 1</li><li>è¡¥ç  = ï¼ˆåŸç  - 1ï¼‰å†å–åç </li></ul></li><li>åœ¨è®¡ç®—æœºä¸­æ— ç¬¦å·æ•°ç”¨åŸç è¡¨ç¤º, æœ‰ç¬¦å·æ•°ç”¨è¡¥ç è¡¨ç¤º</li></ul><p>è¡¥ç çš„æ„ä¹‰å°±æ˜¯å¯ä»¥æ‹¿è¡¥ç å’ŒåŸç ï¼ˆ3çš„äºŒè¿›åˆ¶ï¼‰ç›¸åŠ ï¼Œæœ€ç»ˆåŠ å‡ºä¸€ä¸ªâ€œæº¢å‡ºçš„0â€</p><p>å› æ­¤-1çš„äºŒè¿›åˆ¶åº”è¯¥è¿™æ ·ç®—ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>00000000 00000000 00000000 00000001 //åŸç ï¼š1çš„äºŒè¿›åˆ¶
</span></span><span class=line><span class=cl>11111111 11111111 11111111 11111110 //å–åç ï¼š1çš„äºŒè¿›åˆ¶çš„åç 
</span></span><span class=line><span class=cl>11111111 11111111 11111111 11111111 //åŠ 1ï¼š-1çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼ˆè¡¥ç ï¼‰
</span></span></code></pre></div><h3 id=ç”¨ä½è¿ç®—è®¡ç®—nä¸ªbitèƒ½è¡¨ç¤ºçš„æœ€å¤§æ•°å€¼>ç”¨ä½è¿ç®—è®¡ç®—nä¸ªbitèƒ½è¡¨ç¤ºçš„æœ€å¤§æ•°å€¼<a hidden class=anchor aria-hidden=true href=#ç”¨ä½è¿ç®—è®¡ç®—nä¸ªbitèƒ½è¡¨ç¤ºçš„æœ€å¤§æ•°å€¼>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>const maxWorkerId = -1n ^ (-1n &lt;&lt; 5n)
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// åˆ©ç”¨ä½è¿ç®—è®¡ç®—å‡º5ä½èƒ½è¡¨ç¤ºçš„æœ€å¤§æ­£æ•´æ•°æ˜¯å¤šå°‘
</span></span></code></pre></div><p>-1 å·¦ç§» 5ï¼Œå¾—ç»“æœa ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>        11111111 11111111 11111111 11111111 // -1çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼ˆè¡¥ç ï¼‰
</span></span><span class=line><span class=cl>  11111 11111111 11111111 11111111 11100000 // é«˜ä½æº¢å‡ºçš„ä¸è¦ï¼Œä½ä½è¡¥0
</span></span><span class=line><span class=cl>        11111111 11111111 11111111 11100000 // ç»“æœa
</span></span></code></pre></div><p>-1 å¼‚æˆ– a ï¼š</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>        11111111 11111111 11111111 11111111 // -1çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼ˆè¡¥ç ï¼‰
</span></span><span class=line><span class=cl>    ^   11111111 11111111 11111111 11100000 // ä¸¤ä¸ªæ“ä½œæ•°çš„ä½ä¸­ï¼Œç›¸åŒåˆ™ä¸º0ï¼Œä¸åŒåˆ™ä¸º1
</span></span><span class=line><span class=cl>---------------------------------------------------------------------------
</span></span><span class=line><span class=cl>        00000000 00000000 00000000 00011111 // æœ€ç»ˆç»“æœ31
</span></span></code></pre></div><p>æœ€ç»ˆç»“æœæ˜¯31ï¼ŒäºŒè¿›åˆ¶ <code>00000000 00000000 00000000 00011111</code> è½¬åè¿›åˆ¶å¯ä»¥è¿™ä¹ˆç®—ï¼š</p><p>24+23+22+21+20=16+8+4+2+1=31</p><h3 id=ç”¨maské˜²æ­¢æº¢å‡º>ç”¨maské˜²æ­¢æº¢å‡º<a hidden class=anchor aria-hidden=true href=#ç”¨maské˜²æ­¢æº¢å‡º>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>this.sequence = (this.sequence + 1n) &amp; this.sequenceMask;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// è¿™æ®µä»£ç é€šè¿‡ `ä½ä¸` è¿ç®—ä¿è¯è®¡ç®—çš„ç»“æœèŒƒå›´å§‹ç»ˆæ˜¯ 0-4095
</span></span></code></pre></div><h3 id=ç”¨ä½è¿ç®—æ±‡æ€»ç»“æœ>ç”¨ä½è¿ç®—æ±‡æ€»ç»“æœ<a hidden class=anchor aria-hidden=true href=#ç”¨ä½è¿ç®—æ±‡æ€»ç»“æœ>#</a></h3><p>ä½æˆ–è¿ç®—ï¼ŒåŒä¸€ä½åªè¦æœ‰ä¸€ä¸ªæ˜¯1ï¼Œåˆ™ç»“æœä¸º1ï¼Œå¦åˆ™ä¸º0ã€‚</p><p>ä½è¿ç®—å·¦ç§»è¶…å‡ºçš„æº¢å‡ºéƒ¨åˆ†æ‰”æ‰ï¼Œå³ä¾§ç©ºä½åˆ™è¡¥0ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>return (
</span></span><span class=line><span class=cl>      ((timestamp - this.twepoch) &lt;&lt; this.timestampLeftShift) | // æ—¶é—´å·®å·¦ç§»22
</span></span><span class=line><span class=cl>      (this.dataCenterId &lt;&lt; this.dataCenterIdShift) | // æ•°æ®æ ‡è¯†idå·¦ç§» 17
</span></span><span class=line><span class=cl>      (this.workerId &lt;&lt; this.workerIdShift) | // æœºå™¨idå·¦ç§» 12
</span></span><span class=line><span class=cl>      this.sequence
</span></span><span class=line><span class=cl>    );
</span></span><span class=line><span class=cl>--------------------
</span></span><span class=line><span class=cl>        |
</span></span><span class=line><span class=cl>        |ç®€åŒ–
</span></span><span class=line><span class=cl>       \|/
</span></span><span class=line><span class=cl>--------------------
</span></span><span class=line><span class=cl>return (la) |
</span></span><span class=line><span class=cl>      (lb) |
</span></span><span class=line><span class=cl>      (lc) |
</span></span><span class=line><span class=cl>      sequence;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>æ•°æ®ç¤ºä¾‹ï¼š
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>timestamp: 1505914988849
</span></span><span class=line><span class=cl>twepoch: 1288834974657
</span></span><span class=line><span class=cl>datacenterId: 17
</span></span><span class=line><span class=cl>workerId: 25
</span></span><span class=line><span class=cl>sequence: 0
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>äºŒè¿›åˆ¶è¿‡ç¨‹
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  1 |                    41                        |  5  |   5  |     12
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>   0|0001100 10100010 10111110 10001001 01011100 00|     |      |              //la
</span></span><span class=line><span class=cl>   0|                                              |10001|      |              //lb
</span></span><span class=line><span class=cl>   0|                                              |     |1 1001|              //lc
</span></span><span class=line><span class=cl>or 0|                                              |     |      |â€­0000 00000000â€¬ //sequence
</span></span><span class=line><span class=cl>------------------------------------------------------------------------------------------
</span></span><span class=line><span class=cl>   0|0001100 10100010 10111110 10001001 01011100 00|10001|1 1001|â€­0000 00000000â€¬ //ç»“æœï¼š910499571847892992
</span></span></code></pre></div><h2 id=æ”¯æŒåæ¨æ•°æ®>æ”¯æŒåæ¨æ•°æ®<a hidden class=anchor aria-hidden=true href=#æ”¯æŒåæ¨æ•°æ®>#</a></h2><p>åæ¨æœºå™¨IDã€æ•°æ®ä¸­å¿ƒIDå’Œåˆ›å»ºçš„æ—¶é—´æˆ³</p><ul><li>æœºå™¨ID = id &#187; workerIdShift & ~(-1n &#171; workerIdBits);</li><li>æ•°æ®ä¸­å¿ƒID = id &#187; datacenterIdShift & ~(-1n &#171; datacenterIdBits);</li><li>æ—¶é—´æˆ³ = id &#187; timestampLeftShift & ~(-1n &#171; 41n) + twepoch;</li></ul><p>å‚è€ƒï¼š</p><p>é›ªèŠ±ç®—æ³•</p><ul><li><a href=https://github.com/twitter/snowflake/blob/snowflake-2010/src/main/scala/com/twitter/service/snowflake/IdWorker.scala>Twitterå®˜æ–¹åŸç‰ˆ</a> ç”¨Scalaå†™çš„</li><li><a href=https://developer.twitter.com/en/docs/basics/twitter-ids>Twitter IDï¼ˆSnowflakeï¼‰</a></li><li><a href=https://blog.csdn.net/xiaopeng9275/article/details/72123709>IDç”Ÿæˆå™¨ï¼ŒTwitterçš„é›ªèŠ±ç®—æ³•ï¼ˆJavaï¼‰</a></li><li><a href=https://segmentfault.com/a/1190000011282426>ç†è§£åˆ†å¸ƒå¼idç”Ÿæˆç®—æ³•SnowFlake</a></li><li></li></ul><p>BigInt</p><ul><li><a href=https://zhuanlan.zhihu.com/p/36330307>BigIntï¼šJavaScript ä¸­çš„ä»»æ„ç²¾åº¦æ•´æ•°</a></li><li>BigInt: arbitrary-precision integers in JavaScript<ul><li><a href=https://github.com/GoogleChromeLabs/jsbi#why>chrome jsbi</a></li><li><a href=http://2ality.com/2017/03/es-integer.html>ES proposal: BigInt â€“ arbitrary precision integers</a></li></ul></li><li><a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/BigInt>MDN BigInt è¯­æ³•</a></li><li><a href=https://github.com/tc39/proposal-bigint>tc39: proposal-bigint</a></li><li><a href=https://zhuanlan.zhihu.com/p/36385254>Javascript ææ¡ˆ BigInt çš„ä¸€äº›å‘</a></li></ul><p>å…³äºé™åˆ¶ä¸ºä»…64ä½æ•´æ•°ï¼Œéœ€è¦ç‰¹å®šå¤„ç†ï¼Œå¯ä»¥æç¤ºæ•°æ®é•¿åº¦æº¢å‡ºäº†ã€‚</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// åœ¨ console ä¸­æµ‹è¯•ï¼Œæº¢å‡ºæ€ä¹ˆåŠï¼Œæ€ä¹ˆæ£€æŸ¥å‡ºé—®é¢˜äº†
</span></span><span class=line><span class=cl>var aa = 1n;
</span></span><span class=line><span class=cl>(aa&lt;&lt;62n).toString(2).padStart(64, 0);
</span></span><span class=line><span class=cl>(aa&lt;&lt;65n).toString(2).padStart(64, 0);
</span></span><span class=line><span class=cl>(BigInt.asIntN(64, aa&lt;&lt;62n)).toString(2).padStart(64, 0);
</span></span><span class=line><span class=cl>(BigInt.asIntN(64, aa&lt;&lt;65n)).toString(2).padStart(64, 0);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>const max = 2n ** (64n - 1n) - 1n;
</span></span><span class=line><span class=cl>BigInt.asIntN(64, max); // æœ‰ç¬¦å·æ•°
</span></span><span class=line><span class=cl>BigInt.asUintN(64, max); // æ— ç¬¦å·æ•°
</span></span><span class=line><span class=cl>â†’ 9223372036854775807n
</span></span><span class=line><span class=cl>BigInt.asIntN(64, max + 1n);
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>new BigInt64Array(4)
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://www.catguild.cn/posts/2023081401/><span class=title>Â« Prev</span><br><span>é‚€è¯·ç å®ç°æ–¹æ¡ˆ</span></a></nav></footer></article></main><footer class=footer><span>Copyright
&copy;
2023-2023
<a href=https://www.catguild.cn/ style=color:#939393>çŒ«å…¬ä¼š</a>
All Rights Reserved</span><div class="footer-line thanks"><span class="icp footer-divider">ç‰¹åˆ«æ„Ÿè°¢
<a href=https://gohugo.io target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.111.3">Hugo</a> |
<a href=https://github.com/adityatelange/hugo-PaperMod target=_blank rel=external title="PaperMod 7.0">PaperMod</a> |
<a href=https://github.com target=_blank rel="noopener noreffer">GitHub</a> |
<a href=https://vercel.com target=_blank rel="noopener noreffer">Vercel</a></span></div><div class="footer-line beian"><a href=https://beian.miit.gov.cn/ target=_blank style=color:#939393>çš–ICPå¤‡ 20012821 å·</a>&nbsp;
<span><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=34082602201751" style=display:inline-block;text-decoration:none;height:20px;color:#939393><img src=/img/beian.png style="float:left;margin:0 5px 0 0">
çš–å…¬ç½‘å®‰å¤‡ 34082602201751 å·</a></span></div></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>